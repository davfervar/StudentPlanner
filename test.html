<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Student Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ==========================================================================
           1. THEME & CORE STYLES
           ========================================================================== */
        :root {
            --bg-main-light: #F7F8FC;
            --bg-sidebar-light: #FFFFFF;
            --bg-widget-light: #FFFFFF;
            --bg-input-light: #F0F2F5;
            --bg-hover-light: #EAEFFC;
            --bg-accent-light: #007AFF;
            --bg-accent-hover-light: #0056b3;

            --text-primary-light: #1A1C20;
            --text-secondary-light: #6A7383;
            --text-accent-light: #007AFF;
            --text-on-accent-light: #FFFFFF;

            --border-light: #E8EBF1;
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.04);
            --danger-light: #e74c3c;
            
            --hero-gradient-light: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);

            --bg-main-dark: #121212;
            --bg-sidebar-dark: #1A1A1A;
            --bg-widget-dark: #1E1E1E;
            --bg-input-dark: #2C2C2C;
            --bg-hover-dark: #2F2F2F;
            --bg-accent-dark: #0A84FF;
            --bg-accent-hover-dark: #0060d1;

            --text-primary-dark: #EAEAEA;
            --text-secondary-dark: #9A9A9A;
            --text-accent-dark: #0A84FF;
            --text-on-accent-dark: #FFFFFF;

            --border-dark: #303030;
            --shadow-dark: 0 5px 20px rgba(0, 0, 0, 0.25);
            --danger-dark: #ff5252;
            
            --hero-gradient-dark: linear-gradient(120deg, #0f2027 0%, #203a43 100%);

            --bg-main: var(--bg-main-light);
            --bg-sidebar: var(--bg-sidebar-light);
            --bg-widget: var(--bg-widget-light);
            --bg-input: var(--bg-input-light);
            --bg-hover: var(--bg-hover-light);
            --bg-accent: var(--bg-accent-light);
            --bg-accent-hover: var(--bg-accent-hover-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --text-accent: var(--text-accent-light);
            --text-on-accent: var(--text-on-accent-light);
            --border-color: var(--border-light);
            --shadow: var(--shadow-light);
            --danger: var(--danger-light);
            --hero-gradient: var(--hero-gradient-light);
        }

        body.dark-mode {
            --bg-main: var(--bg-main-dark);
            --bg-sidebar: var(--bg-sidebar-dark);
            --bg-widget: var(--bg-widget-dark);
            --bg-input: var(--bg-input-dark);
            --bg-hover: var(--bg-hover-dark);
            --bg-accent: var(--bg-accent-dark);
            --bg-accent-hover: var(--bg-accent-hover-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --text-accent: var(--text-accent-dark);
            --text-on-accent: var(--text-on-accent-dark);
            --border-color: var(--border-dark);
            --shadow: var(--shadow-dark);
            --danger: var(--danger-dark);
            --hero-gradient: var(--hero-gradient-dark);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        /* ==========================================================================
           2. LAYOUT & SIDEBAR
           ========================================================================== */

        .sidebar {
            width: 260px; height: 100vh; background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color); padding: 20px;
            display: flex; flex-direction: column; flex-shrink: 0;
            position: fixed; z-index: 100; transition: all 0.3s;
        }
        .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        
        .profile-pic-label { cursor: pointer; }
        .profile-pic {
            width: 40px; height: 40px; border-radius: 50%;
            background-color: var(--bg-input);
            object-fit: cover;
            border: 2px solid var(--border-color);
            transition: transform 0.2s, border-color 0.2s;
        }
        .profile-pic:hover { transform: scale(1.1); border-color: var(--text-accent); }

        .sidebar-header h1 { font-size: 1.2rem; font-weight: 600; }
        .main-nav { flex-grow: 1; overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .main-nav::-webkit-scrollbar { display: none; }
        .nav-section { margin-bottom: 10px; }
        .nav-section-title {
            font-size: 0.75rem; text-transform: uppercase; font-weight: 600;
            color: var(--text-secondary); padding: 0 12px 10px 12px;
        }
        .nav-link, .filter-link {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            border-radius: 8px; text-decoration: none; color: var(--text-secondary);
            font-weight: 500; transition: all 0.2s; margin: 4px 0;
            cursor: pointer; border: none; background: none; width: 100%; text-align: left;
            font-size: 1rem;
        }
        .nav-link:hover, .filter-link:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .nav-link.active { background-color: var(--bg-accent); color: var(--text-on-accent); font-weight: 600; }
        .filter-link.active { color: var(--text-accent); font-weight: 600; background-color: var(--bg-hover); }

        .nav-icon { font-size: 1.2rem; }

        .collapsible-nav-section { display: flex; flex-direction: column; }
        .task-filters-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            padding-left: 20px;
        }
        .collapsible-nav-section.expanded .task-filters-container { max-height: 500px; }
        .search-container { padding: 5px 10px 10px 30px; }
        #sidebar-search { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; }
        #sidebar-search:focus { outline: none; border-color: var(--text-accent); }


        .app-container {
            flex-grow: 1; margin-left: 260px; display: flex;
            flex-direction: column; height: 100vh;
        }

        .main-content { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ==========================================================================
           3. SHARED COMPONENTS & MODALS
           ========================================================================== */
        
        .hero-banner { background: var(--hero-gradient); border-radius: 12px; padding: 30px; margin-bottom: 25px; position: relative; color: var(--text-on-accent); overflow: hidden; box-shadow: var(--shadow); }
        .hero-banner h2 { font-size: 2.5rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .hero-banner p { font-size: 1rem; opacity: 0.9; margin-top: 5px; }
        .up-next-card { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; width: 280px; border: 1px solid rgba(255,255,255,0.3); }
        .up-next-card h4 { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; opacity: 0.8; margin-bottom: 10px; }
        .up-next-details { display: flex; align-items: center; gap: 12px; }
        .up-next-timeline { width: 3px; height: 40px; background: var(--text-on-accent); border-radius: 2px; opacity: 0.8; }
        .up-next-info h5 { font-size: 1.1rem; font-weight: 600; }
        .up-next-info p { font-size: 0.9rem; opacity: 0.8; margin-top: 2px; }

        .primary-btn { padding: 12px 20px; background-color: var(--bg-accent); color: var(--text-on-accent); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: background-color 0.2s, transform 0.2s; }
        .primary-btn:hover { background-color: var(--bg-accent-hover); transform: translateY(-2px); }
        .secondary-btn { padding: 10px 18px; background-color: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: background-color 0.2s; }
        .secondary-btn:hover { background-color: var(--border-color); }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-header h2 { font-size: 1.8rem; font-weight: 700; }
        .widget { background-color: var(--bg-widget); border-radius: 12px; border: 1px solid var(--border-color); padding: 20px; box-shadow: var(--shadow); transition: all 0.3s; }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .widget-header h3 { font-size: 1.1rem; font-weight: 600; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeInModal 0.3s ease; }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: var(--bg-widget); padding: 30px; border-radius: 12px; box-shadow: var(--shadow-dark); width: 90%; max-width: 550px; animation: popInModal 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; padding-right: 15px; margin-right: -15px; }
        .modal-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; flex-shrink: 0; }
        .modal-header .modal-icon { font-size: 1.8rem; color: var(--text-accent); }
        .modal-header h3 { font-size: 1.5rem; font-weight: 600; }
        .close-modal-btn { background: none; border: none; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; margin-left: auto; }
        .modal-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; border-top: 1px solid var(--border-color); padding-top: 20px;}
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-primary); }
        .form-group label sup { color: var(--danger); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); font-size: 1rem; font-family: 'Inter', sans-serif; transition: all 0.2s; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--text-accent); box-shadow: 0 0 0 2px var(--bg-hover); }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popInModal { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* Add New Item Menu Modal (New Design) */
        #add-item-menu .modal-content { max-width: 320px; padding: 15px; }
        .add-item-options { list-style: none; padding: 0; margin: 0; }
        .add-item-option { display: flex; align-items: center; gap: 20px; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .add-item-option:hover, .add-item-option.selected { background-color: var(--bg-hover); }
        .add-item-option .item-icon { font-size: 1.5rem; width: 30px; text-align: center; color: var(--text-secondary); }
        .add-item-option .item-text { font-size: 1rem; font-weight: 500; }
        .add-item-option .item-premium-icon { margin-left: auto; color: #FDB827; }

        /* Vacation Photo Upload */
        .photo-upload-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .photo-upload-area:hover { border-color: var(--text-accent); background-color: var(--bg-hover); }
        #vacation-photo-preview { max-width: 100%; max-height: 150px; border-radius: 8px; margin-top: 10px; }

        /* ==========================================================================
           4. DASHBOARD & WIDGETS
           ========================================================================== */
        
        #dashboard-view .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .dashboard-main, .dashboard-side { display: flex; flex-direction: column; gap: 25px; }
        .tasks-overview h4 { font-size: 1.2rem; margin-bottom: 15px; }
        .task-list-item { display: flex; align-items: center; gap: 12px; padding: 12px 5px; border-bottom: 1px solid var(--border-color); }
        .task-list-item:last-child { border-bottom: none; }
        .task-checkbox { width: 18px; height: 18px; accent-color: var(--bg-accent); flex-shrink: 0; cursor: pointer; }
        .task-details { flex-grow: 1; }
        .task-details .task-name { font-weight: 500; }
        .task-details .task-name.completed { text-decoration: line-through; color: var(--text-secondary); }
        .task-subject-tag { font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 12px; color: white; }

        .pomodoro-widget { text-align: center; background: var(--hero-gradient); color: var(--text-on-accent); overflow: hidden; padding-bottom: 15px; }
        .pomodoro-widget h3 { color: var(--text-on-accent); opacity: 0.9; font-weight: 600; font-size: 1.1rem; }
        .pomodoro-widget .timer-visual { position: relative; width: 140px; height: 140px; margin: 10px auto 5px auto; }
        .pomodoro-widget svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .pomodoro-widget .timer-circle-bg { fill: none; stroke: rgba(255, 255, 255, 0.25); stroke-width: 10; }
        .pomodoro-widget .timer-circle-progress { fill: none; stroke: #FFFFFF; stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.5s ease; }
        .pomodoro-widget #pomodoro-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.2rem; font-weight: 600; color: var(--text-on-accent); letter-spacing: 1px; }
        #pomodoro-session-display { font-size: 0.9rem; font-weight: 500; color: var(--text-on-accent); opacity: 0.8; margin-bottom: 10px; }
        .pomodoro-widget .pomodoro-controls { display: flex; justify-content: center; align-items: center; gap: 15px; }
        .pomodoro-control-btn { background-color: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: var(--text-on-accent); border-radius: 50%; width: 44px; height: 44px; cursor: pointer; display: grid; place-items: center; transition: all 0.2s ease-out; }
        .pomodoro-control-btn:hover { background-color: rgba(255,255,255,0.4); transform: scale(1.1); }
        .pomodoro-control-btn svg { width: 20px; height: 20px; fill: currentColor; transition: transform 0.3s ease; }
        #pomodoro-toggle-btn.is-running svg { transform: scale(0.8); }

        .habit-tracker-widget #habit-list-container { display: flex; flex-direction: column; gap: 12px; max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .habit-row { display: flex; align-items: center; gap: 10px; position: relative; }
        .habit-row:hover .delete-habit-btn { opacity: 1; transform: scale(1); }
        .habit-name { flex-grow: 1; font-size: 0.9rem; font-weight: 500; }
        .delete-habit-btn { background: none; border: none; color: var(--text-secondary); font-size: 1rem; cursor: pointer; padding: 2px; opacity: 0; transform: scale(0.8); transition: all 0.2s; }
        .delete-habit-btn:hover { color: var(--danger); }
        .habit-week-tracker { display: flex; gap: 5px; }
        .habit-week-tracker .day-label { width: 28px; height: 28px; border-radius: 50%; display: grid; place-items: center; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 2px solid var(--border-color); color: var(--text-secondary); transition: all 0.2s; }
        .habit-week-tracker input { display: none; }
        .habit-week-tracker input:checked + .day-label { background-color: var(--bg-accent); border-color: var(--bg-accent); color: var(--text-on-accent); }

        .side-widget-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .side-widget { background: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; text-align: center; }
        .side-widget-value { font-size: 1.5rem; font-weight: 700; color: var(--text-accent); }
        .side-widget-label { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-top: 5px; }
        #quick-task-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; margin-top: 15px; }
        #quick-task-input:focus { outline: none; border-color: var(--text-accent); }

        .schedule-widget h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        .schedule-timeline { position: relative; width: 100%; height: 24px; background-color: var(--bg-input); border-radius: 12px; overflow: hidden; }
        .schedule-event { position: absolute; top: 0; height: 100%; border-radius: 12px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .schedule-event:hover { transform: scaleY(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .schedule-time-labels { display: flex; justify-content: space-between; padding: 8px 2px 0 2px; font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }

        /* ==========================================================================
           5. TASKS VIEW
           ========================================================================== */
        .tasks-section { margin-bottom: 30px; }
        .tasks-section-header { font-size: 1.5rem; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        #tasks-view-container { display: flex; flex-direction: column; gap: 12px; }
        
        .task-card { display: flex; align-items: center; gap: 15px; padding: 15px; background-color: var(--bg-widget); border-radius: 10px; border: 1px solid var(--border-color); transition: box-shadow 0.2s, border-color 0.2s; }
        .task-card:hover { box-shadow: var(--shadow); border-color: var(--text-accent); }
        .task-card .task-checkbox { width: 20px; height: 20px; }
        .task-card .task-details { flex-grow: 1; }
        .task-card .task-name { font-weight: 600; font-size: 1rem; }
        .task-card .task-name.completed { text-decoration: line-through; color: var(--text-secondary); font-weight: 500; }
        .task-card .task-due-date { font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; font-weight: 500; }
        .task-tags-container { display: flex; align-items: center; gap: 8px; flex-shrink: 0; margin-left: auto; }
        .task-category-tag { font-size: 0.75rem; font-weight: 600; padding: 4px 10px; border-radius: 12px; background-color: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .task-actions { display: flex; gap: 5px; }
        .delete-btn { background: none; border: none; color: var(--text-secondary); font-size: 1rem; cursor: pointer; padding: 5px; border-radius: 50%; width: 32px; height: 32px; display: grid; place-items: center; transition: all 0.2s; }
        .delete-btn:hover { background-color: var(--bg-hover); color: var(--danger); }
        .edit-btn:hover { background-color: var(--bg-hover); color: var(--text-accent); }

        /* ==========================================================================
           6. CLASSES VIEW
           ========================================================================== */
        #classes-view .classes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .class-card { padding: 20px; border-radius: 10px; color: white; position: relative; display: flex; flex-direction: column; }
        .class-card h4 { font-size: 1.2rem; margin-bottom: 5px; }
        .class-card p { font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px; }
        .class-card-details { margin-top: auto; font-size: 0.85rem; opacity: 0.9; }
        .class-card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .class-action-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; transition: background 0.2s; }
        .class-action-btn:hover { background: rgba(255,255,255,0.4); }
        .color-picker { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        .color-option { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; position: relative; display: grid; place-items: center; }
        .color-option.selected { border-color: var(--bg-accent); transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .color-option::after { content: '✔'; color: #fff; font-size: 1.2rem; line-height: 1; text-shadow: 0 0 5px rgba(0,0,0,0.5); transform: scale(0); transition: transform 0.2s ease-out; }
        .color-option.selected::after { transform: scale(1); }
        .color-option[data-color-value^="#f"].selected::after { color: #000; text-shadow: none; }
        .schedule-entry { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }

        /* ==========================================================================
           7. CALENDAR VIEW
           ========================================================================== */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; }
        .calendar-header h3 { font-size: 1.4rem; font-weight: 600; }
        .calendar-nav { display: flex; gap: 8px; }
        .calendar-grid-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-name { text-align: right; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); padding: 8px; }
        .calendar-day { min-height: 120px; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; font-size: 0.9rem; font-weight: 500; transition: border-color 0.2s; display: flex; flex-direction: column; }
        .calendar-day:hover { border-color: var(--text-accent); }
        .calendar-day.not-current-month { background-color: var(--bg-input); color: var(--text-secondary); }
        .day-number { text-align: right; margin-bottom: 5px; font-weight: 600; }
        .calendar-day.today .day-number { color: var(--bg-accent); font-weight: 700; }
        .calendar-events { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .calendar-event-item { font-size: 0.75rem; padding: 4px 6px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; cursor: pointer; }
        .calendar-vacation-bar { background-color: var(--text-accent); margin: -8px -8px 5px -8px; padding: 2px 8px; text-align: center; color: var(--text-on-accent); font-weight: 500; font-size: 0.8rem; }


        /* ==========================================================================
           8. NOTEPAD & OTHER MODALS
           ========================================================================== */
        #notepad-modal .modal-content { max-width: 900px; width: 90%; height: 85vh; padding: 0; }
        .notepad-container { flex-grow: 1; display: flex; min-height: 0; }
        .notes-list-panel { width: 280px; flex-shrink: 0; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .notes-list-header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        #notes-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex-grow: 1; }
        .note-list-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: background-color 0.2s; position: relative; }
        .note-list-item:hover { background-color: var(--bg-hover); }
        .note-list-item.active { background-color: var(--bg-accent); color: var(--text-on-accent); }
        .note-list-item.active .note-list-item-date { color: var(--text-on-accent); opacity: 0.8; }
        .note-list-item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-list-item-date { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }
        #note-editor-panel { flex-grow: 1; display: flex; flex-direction: column; padding: 20px; }
        #active-note-title { font-size: 1.5rem; font-weight: 600; border: none; background: transparent; color: var(--text-primary); width: 100%; margin-bottom: 10px; padding: 10px 0; border-bottom: 1px solid var(--border-color); outline: none; }
        #active-note-content { flex-grow: 1; width: 100%; border: none; padding: 15px; font-family: 'Inter', sans-serif; font-size: 1rem; background-color: var(--bg-input); color: var(--text-primary); outline: none; resize: none; border-radius: 8px; }
        #delete-note-btn { background: none; border: none; color: var(--danger); font-size: 1.2em; cursor: pointer; opacity: 0; transition: opacity .2s; position: absolute; right: 12px; top: 12px; }
        .note-list-item:hover #delete-note-btn { opacity: 1; }

    </style>
</head>
<body class="">

    <aside class="sidebar">
        <div class="sidebar-header">
            <label for="pfp-upload" class="profile-pic-label">
                <img id="profile-pic" class="profile-pic" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzZBNzM4MyIgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCI+PHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDNjMS42NiAwIDMgMS4zNCAzIDNzLTEuMzQgMy0zIDMtMy0xLjM0LTMtMyAxLjM0LTMgMy0zem0wIDE0LjJjLTIuNSAwLTQuNzEtMS4yOC02LTEuMjguMDMtMi4zOCAzLjk5LTQuMTIgNi00LjEyIDIgMCA1Ljk3IDEuNzQgNiA0LjEyLTEuMjktMS0zLjUtMS4yLTUtMS4yeiIvPjwvc3ZnPg==" alt="Foto de Perfil">
            </label>
            <input type="file" id="pfp-upload" accept="image/*" style="display:none;">
            <h1>Ultimate Planner</h1>
        </div>

        <div class="main-nav">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a href="#" class="nav-link active" data-view="dashboard-view"><span class="nav-icon">🏠</span> Dashboard</a>
                
                <div id="tasks-nav-item" class="collapsible-nav-section">
                    <a href="#" class="nav-link" data-view="tasks-view"><span class="nav-icon">📋</span> Tareas</a>
                    <div class="task-filters-container">
                        <div class="search-container">
                            <input type="search" id="sidebar-search" placeholder="Buscar...">
                        </div>
                        <button class="filter-link active" data-category="all"><span class="nav-icon" style="opacity:0;"></span> Todas</button>
                        <button class="filter-link" data-category="Tareas"><span class="nav-icon" style="opacity:0;"></span> ✔️ Tareas</button>
                        <button class="filter-link" data-category="Exámenes"><span class="nav-icon" style="opacity:0;"></span> ✍️ Exámenes</button>
                    </div>
                </div>

                <a href="#" class="nav-link" data-view="calendar-view"><span class="nav-icon">📅</span> Calendario</a>
                <a href="#" class="nav-link" data-view="classes-view"><span class="nav-icon">📚</span> Clases</a>
            </div>
             <div class="nav-section">
                <div class="nav-section-title">Herramientas</div>
                <a href="#" class="nav-link" id="open-notepad-btn"><span class="nav-icon">📝</span> Bloc de Notas</a>
                <a href="#" class="nav-link" id="open-horoscope-btn"><span class="nav-icon">🔮</span> Horóscopo</a>
            </div>
        </div>
        <div class="sidebar-footer">
            <a href="#" class="nav-link theme-toggle-btn">
                <span class="nav-icon" id="theme-icon">🌙</span>
                <span id="theme-text">Dark Mode</span>
            </a>
        </div>
    </aside>

    <div class="app-container">
        <main class="main-content">
            <div id="dashboard-view" class="view active">
                <div class="page-header"><h2>Dashboard</h2><button class="primary-btn" id="add-item-btn-dash">+ Añadir Nuevo</button></div>
                <div class="hero-banner"><h2 id="greeting">Buenas noches.</h2><p id="task-summary">Tienes 0 tareas para hoy.</p><div class="up-next-card"><h4>A CONTINUACIÓN</h4><div class="up-next-details" id="up-next-container"></div></div></div>
                <div class="dashboard-grid">
                    <div class="dashboard-main">
                        <div class="widget tasks-overview"><div class="widget-header"><h4>Tareas de Hoy</h4><button class="secondary-btn" data-view-target="tasks-view">Ver Todas</button></div><div id="today-tasks-list"></div><input type="text" id="quick-task-input" placeholder="Añadir tarea rápida y presionar Enter..."></div>
                        <div class="widget tasks-overview"><h4>Próximamente</h4><div id="upcoming-tasks-list"></div></div>
                    </div>
                    <div class="dashboard-side">
                        <div class="side-widget-container"><div class="side-widget"><div class="side-widget-value" id="streak-display">🔥 0</div><div class="side-widget-label">Racha</div></div><div class="side-widget"><div class="side-widget-value" id="weather-display">--°</div><div class="side-widget-label" id="weather-city"></div></div></div>
                        <div class="widget schedule-widget"><h3>Horario de Hoy</h3><div class="schedule-timeline" id="schedule-timeline-content"></div><div class="schedule-time-labels"><span>6am</span><span>10am</span><span>2pm</span><span>6pm</span><span>10pm</span></div></div>
                        <div class="widget pomodoro-widget"><h3>Pomodoro</h3><div class="timer-visual"><svg><defs><linearGradient id="pomodoro-gradient-dynamic" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" id="pomodoro-grad-stop1" stop-color="#FFFFFF" /><stop offset="100%" id="pomodoro-grad-stop2" stop-color="#FFFFFF" /></linearGradient></defs><circle class="timer-circle-bg" cx="70" cy="70" r="65"></circle><circle id="pomodoro-progress" class="timer-circle-progress" cx="70" cy="70" r="65"></circle></svg><div id="pomodoro-display">25:00</div></div><div id="pomodoro-session-display"></div><div class="pomodoro-controls"><button class="pomodoro-control-btn" id="pomodoro-toggle-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></button><button class="pomodoro-control-btn" id="pomodoro-reset-btn"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button><button class="pomodoro-control-btn" id="pomodoro-settings-btn"><svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg></button></div></div>
                        <div class="widget habit-tracker-widget"><div class="widget-header"><h3>Rastreador de Hábitos</h3></div><div id="habit-list-container"></div><div class="form-group" style="margin-top: 15px; margin-bottom: 0;"><input type="text" id="new-habit-input" placeholder="Añadir nuevo hábito..."></div></div>
                    </div>
                </div>
            </div>
            
            <div id="tasks-view" class="view">
                 <div class="page-header"><h2 id="tasks-view-title">Todas las Tareas</h2><button class="primary-btn" id="add-item-btn-tasks">+ Añadir Nuevo</button></div>
                <div id="tasks-view-container"></div>
            </div>

            <div id="calendar-view" class="view">
                <div class="page-header"><h2>Calendario</h2><button class="primary-btn" id="add-item-btn-cal">+ Añadir Nuevo</button></div>
                <div class="widget"><div class="calendar-header"><h3 id="calendar-month-year"></h3><div class="calendar-nav"><button class="secondary-btn" id="cal-prev-btn"><</button><button class="secondary-btn" id="cal-next-btn">></button></div></div><div class="calendar-grid-container" id="calendar-header-days"></div><div class="calendar-grid-container" id="calendar-body"></div></div>
            </div>
            <div id="classes-view" class="view">
                <div class="page-header"><h2>Clases</h2><button class="primary-btn" id="add-item-btn-classes">+ Añadir Nuevo</button></div>
                <div class="classes-grid" id="classes-grid-container"></div>
            </div>
        </main>
    </div>
    
    <div id="add-item-menu" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal-btn" data-modal-id="add-item-menu" style="position:absolute; top:10px; right:10px;">&times;</button>
            <ul class="add-item-options">
                <li class="add-item-option" data-item-type="task"><span class="item-icon">📝</span><span class="item-text">Tarea</span></li>
                <li class="add-item-option" data-item-type="class"><span class="item-icon">👨‍🏫</span><span class="item-text">Clase</span></li>
                <li class="add-item-option" data-item-type="exam"><span class="item-icon">🅰️</span><span class="item-text">Examen</span></li>
                <li class="add-item-option" data-item-type="vacation"><span class="item-icon">🏖️</span><span class="item-text">Vacaciones</span></li>
                <li class="add-item-option" data-item-type="xtra"><span class="item-icon">⚽</span><span class="item-text">Extra</span><span class="item-premium-icon">👑</span></li>
            </ul>
             <div style="margin-top:15px; text-align:center;"><button class="primary-btn" id="add-new-btn-from-menu" style="width:100%;">+ Add new</button></div>
        </div>
    </div>
    <div id="class-modal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><span class="modal-icon">📚</span><h3 id="class-modal-title">Nueva Clase</h3><button class="close-modal-btn" data-modal-id="class-modal">&times;</button></div><div class="modal-body"><form id="class-form"><input type="hidden" id="class-id"><div class="form-group"><label for="class-name">Nombre de la Clase/Materia<sup>*</sup></label><input type="text" id="class-name" required></div><div class="form-group"><label for="class-teacher">Profesor</label><input type="text" id="class-teacher"></div><div class="form-row"><div class="form-group"><label for="class-room">Aula</label><input type="text" id="class-room"></div><div class="form-group"><label for="class-building">Edificio</label><input type="text" id="class-building"></div></div><div class="form-group"><label for="class-mode">Modo<sup>*</sup></label><select id="class-mode" required><option value="In Person">Presencial</option><option value="Online">En Línea</option><option value="Hybrid">Híbrido</option></select></div><div class="form-group"><label>Horario</label><div id="schedule-container"></div><button type="button" class="secondary-btn" id="add-schedule-btn">+ Añadir Horario</button></div><div class="form-group"><label>Color</label><div class="color-picker" id="class-color-picker"></div></div></form></div><div class="modal-actions"><button type="button" class="secondary-btn close-modal-btn" data-modal-id="class-modal">Cancelar</button><button type="submit" form="class-form" class="primary-btn">Guardar Clase</button></div></div>
    </div>
     <div id="task-modal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><span class="modal-icon">📝</span><h3 id="task-modal-title">Nueva Tarea</h3><button class="close-modal-btn" data-modal-id="task-modal">&times;</button></div><form id="task-form" class="modal-body"><input type="hidden" id="task-id"><input type="hidden" id="task-type-hidden"><div class="form-group"><label for="task-title">Título<sup>*</sup></label><input type="text" id="task-title" required></div><div class="form-group"><label for="task-details">Detalles</label><textarea id="task-details"></textarea></div><div class="form-group"><label for="task-class">Clase Asociada</label><select id="task-class" required></select></div><div class="form-row"><div class="form-group"><label for="task-due-date">Fecha de Entrega<sup>*</sup></label><input type="date" id="task-due-date" required></div><div class="form-group"><label for="task-time">Hora</label><input type="time" id="task-time"></div></div></form><div class="modal-actions"><button type="button" class="secondary-btn close-modal-btn" data-modal-id="task-modal">Cancelar</button><button type="submit" form="task-form" class="primary-btn">Guardar</button></div></div>
    </div>
     <div id="vacation-modal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><span class="modal-icon">🏖️</span><h3 id="vacation-modal-title">Nuevas Vacaciones</h3><button class="close-modal-btn" data-modal-id="vacation-modal">&times;</button></div><form id="vacation-form" class="modal-body"><input type="hidden" id="vacation-id"><div class="form-group"><label for="vacation-name">Nombre<sup>*</sup></label><input type="text" id="vacation-name" placeholder="Ej: Vacaciones de Verano" required></div><div class="form-group"><label for="vacation-details">Detalles</label><textarea id="vacation-details"></textarea></div><div class="form-row"><div class="form-group"><label for="vacation-start-date">Fecha de Inicio<sup>*</sup></label><input type="date" id="vacation-start-date" required></div><div class="form-group"><label for="vacation-end-date">Fecha de Fin<sup>*</sup></label><input type="date" id="vacation-end-date" required></div></div><div class="form-group"><label>Foto</label><div id="vacation-photo-upload-area" class="photo-upload-area"><p>Haz clic para subir una foto</p></div><img id="vacation-photo-preview" src="" alt="Previsualización de foto" style="display:none;" /><input type="file" id="vacation-photo-input" accept="image/*" style="display:none;"></div></form><div class="modal-actions"><button type="button" class="secondary-btn close-modal-btn" data-modal-id="vacation-modal">Cancelar</button><button type="submit" form="vacation-form" class="primary-btn">Guardar</button></div></div>
    </div>
    <div id="notepad-modal" class="modal-overlay"><div class="modal-content" style="max-width: 900px; width: 90%; height: 85vh; padding: 0;"><div class="modal-header" style="padding: 15px 20px;"><h3>Bloc de Notas</h3><button class="close-modal-btn" data-modal-id="notepad-modal">&times;</button></div><div class="notepad-container"><div class="notes-list-panel"><div class="notes-list-header"><button id="new-note-btn" class="primary-btn" style="width: 100%;">+ Nueva Nota</button></div><ul id="notes-list"></ul></div><div class="note-editor-panel" id="note-editor-panel"></div></div></div></div>
    <div id="horoscope-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Tu Horóscopo</h3><button class="close-modal-btn" data-modal-id="horoscope-modal">&times;</button></div><div class="modal-body" style="text-align: center;"><div id="horoscope-emoji" style="font-size: 4rem; margin-bottom: 15px;"></div><p id="horoscope-text" style="font-size: 1.1rem; line-height: 1.6;"></p></div></div></div>
    <div id="pomodoro-settings-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Ajustes del Pomodoro</h3><button class="close-modal-btn" data-modal-id="pomodoro-settings-modal">&times;</button></div><div class="modal-body"><div class="form-group"><label for="pomodoro-focus-time">Tiempo de Foco (min)</label><input type="number" id="pomodoro-focus-time" min="1"></div><div class="form-group"><label for="pomodoro-break-time">Tiempo de Descanso (min)</label><input type="number" id="pomodoro-break-time" min="1"></div><div class="form-group"><label for="pomodoro-sessions-goal">Meta de Sesiones</label><input type="number" id="pomodoro-sessions-goal" min="1"></div><div class="form-group"><label>Colores Predefinidos</label><div class="color-picker" id="pomodoro-color-presets"></div></div><div class="form-group"><label>Color Personalizado</label><div class="custom-color-container"><input type="color" id="pomodoro-custom-color" value="#FFFFFF"><span> Toca para elegir</span></div></div></div><div class="modal-actions"><button type="button" class="primary-btn close-modal-btn" data-modal-id="pomodoro-settings-modal">Hecho</button></div></div></div>

    <audio id="alert-sound" src="https://www.soundjay.com/buttons/beep-07.mp3" preload="auto"></audio>

    <script>
    (() => {
        const App = {
            state: {
                classes: [],
                tasks: [],
                vacations: [],
                habits: [],
                notes: [],
                activeNoteId: null,
                pomodoro: { isRunning: false, isBreak: false, timeLeft: 25 * 60, intervalId: null, settings: { focus: 25, break: 5 }, progressColor: 'gradient:#FF8C00,#FF0080', sessions: { current: 0, goal: 4 } },
                streak: { count: 0, lastLogin: null },
                theme: 'light',
                currentView: 'dashboard-view',
                calendar: { date: new Date() },
                profilePic: null,
                taskFilters: { category: 'all', searchTerm: '' },
                taskTypes: ['Tareas', 'Exámenes'],
                classColorPalette: ['#FF6B6B', '#FF9F43', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', '#EF476F', '#6B4226', '#7209B7', '#3A86FF', '#FB5607', '#8338EC'],
                pomodoroColorPresets: [ { name: 'Atardecer', value: 'gradient:#FF8C00,#FF0080' }, { name: 'Océano', value: 'gradient:#00BFFF,#1E90FF' }, { name: 'Bosque', value: 'gradient:#228B22,#3CB371' }, { name: 'Neón', value: 'gradient:#00FFFF,#FF00FF' }, { name: 'Galaxia', value: 'gradient:#483D8B,#8A2BE2' }, { name: 'Blanco', value: '#FFFFFF' } ]
            },

            dataManager: {
                save() {
                    const stateToSave = {
                        classes: App.state.classes, tasks: App.state.tasks, vacations: App.state.vacations,
                        habits: App.state.habits, notes: App.state.notes, activeNoteId: App.state.activeNoteId,
                        streak: App.state.streak, theme: App.state.theme, profilePic: App.state.profilePic,
                        pomodoro: { settings: App.state.pomodoro.settings, progressColor: App.state.pomodoro.progressColor, sessionsGoal: App.state.pomodoro.sessions.goal }
                    };
                    localStorage.setItem('ultimatePlannerState', JSON.stringify(stateToSave));
                },
                load() {
                    const loadedState = JSON.parse(localStorage.getItem('ultimatePlannerState'));
                    if (loadedState) {
                        if (loadedState.pomodoro) { Object.assign(App.state.pomodoro, loadedState.pomodoro); delete loadedState.pomodoro; }
                        Object.assign(App.state, loadedState);
                        App.state.calendar.date = new Date();
                    }
                },
                addClass(classData) { App.state.classes.push({ id: `c_${Date.now()}`, ...classData }); this.save(); },
                updateClass(classData) { const i = App.state.classes.findIndex(c => c.id === classData.id); if (i > -1) App.state.classes[i] = classData; this.save(); },
                deleteClass(id) { App.state.classes = App.state.classes.filter(c => c.id !== id); App.state.tasks.forEach(t => { if(t.classId === id) t.classId = 'general'; }); this.save(); },
                getClass: (id) => App.state.classes.find(c => c.id === id),
                getClassByName(name) { return App.state.classes.find(c => c.name.toLowerCase() === name.toLowerCase()); },
                
                addTask(task) { App.state.tasks.push({ id: `t_${Date.now()}`, completed: false, ...task }); this.save(); },
                updateTask(task) { const i = App.state.tasks.findIndex(t => t.id === task.id); if (i > -1) App.state.tasks[i] = { ...App.state.tasks[i], ...task}; this.save(); },
                deleteTask(id) { App.state.tasks = App.state.tasks.filter(t => t.id !== id); this.save(); },
                toggleTask(id) { const task = App.state.tasks.find(t => t.id === id); if (task) task.completed = !task.completed; this.save(); },
                getTask: (id) => App.state.tasks.find(t => t.id === id),
                getTasksForDate(date) { const dateStr = date.toISOString().split('T')[0]; return App.state.tasks.filter(t => t.dueDate === dateStr); },
                getUpcomingTasks() { const today = new Date(); today.setHours(0,0,0,0); return App.state.tasks.filter(t => new Date(t.dueDate) > today && !t.completed).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).slice(0, 5); },
                getUpNextItem() { const now = new Date(); const todayIndex = (now.getDay() + 6) % 7; const upcomingToday = []; App.state.classes.forEach(cls => { (cls.schedule || []).forEach(slot => { if(slot.day == todayIndex) { const [startH, startM] = slot.startTime.split(':').map(Number); const eventStart = new Date(); eventStart.setHours(startH, startM, 0, 0); if (eventStart > now) { upcomingToday.push({ ...cls, ...slot, type: 'class', eventStart }); } } }); }); return upcomingToday.sort((a,b) => a.eventStart - b.eventStart)[0]; },
                
                addVacation(vacation) { App.state.vacations.push({ id: `v_${Date.now()}`, ...vacation }); this.save(); },
                updateVacation(vacation) { const i = App.state.vacations.findIndex(v => v.id === vacation.id); if (i > -1) App.state.vacations[i] = vacation; this.save(); },
                deleteVacation(id) { App.state.vacations = App.state.vacations.filter(v => v.id !== id); this.save(); },

                addHabit(name) { App.state.habits.push({ id: `h_${Date.now()}`, name, completion: Array(7).fill(false) }); this.save(); },
                deleteHabit(id) { App.state.habits = App.state.habits.filter(h => h.id !== id); this.save(); },
                toggleHabit(id, dayIndex) { const habit = App.state.habits.find(h => h.id === id); if (habit) habit.completion[dayIndex] = !habit.completion[dayIndex]; this.save(); },
                resetWeeklyHabits() { const today = new Date(); const lastReset = localStorage.getItem('habitLastReset'); if (today.getDay() === 1 && today.toDateString() !== lastReset) { App.state.habits.forEach(h => h.completion.fill(false)); localStorage.setItem('habitLastReset', today.toDateString()); this.save(); } },
                addNote() { const newNote = { id: `n_${Date.now()}`, title: 'Nueva Nota', content: '', lastModified: Date.now() }; App.state.notes.unshift(newNote); App.state.activeNoteId = newNote.id; this.save(); return newNote; },
                updateNote(id, { title, content }) { const note = App.state.notes.find(n => n.id === id); if(note) { Object.assign(note, {title, content, lastModified: Date.now()}); } this.save(); },
                deleteNote(id){ App.state.notes = App.state.notes.filter(n => n.id !== id); if(App.state.activeNoteId === id) App.state.activeNoteId = App.state.notes[0]?.id || null; this.save(); },
                updateStreak() { const today = new Date().toDateString(); if (!App.state.streak || App.state.streak.lastLogin === today) return; const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); if (App.state.streak.lastLogin === yesterday.toDateString()) { App.state.streak.count++; } else { App.state.streak.count = 1; } App.state.streak.lastLogin = today; this.save(); }
            },
            
            ui: {
                init() { this.applyTheme(); this.renderProfilePic(); this.renderAll(); this.setupEventListeners(); this.startClocks(); App.ui.pomodoro.reset(true, false); },
                renderAll() { this.renderView(); this.renderDashboard(); this.renderTasksView(); this.renderClassesView(); this.renderCalendar(); },
                applyTheme() { document.body.classList.toggle('dark-mode', App.state.theme === 'dark'); document.getElementById('theme-icon').textContent = App.state.theme === 'dark' ? '☀️' : '🌙'; document.getElementById('theme-text').textContent = App.state.theme === 'dark' ? 'Light Mode' : 'Dark Mode'; },
                startClocks() { const update = () => { this.renderGreeting(); }; update(); setInterval(update, 60000); },
                renderGreeting() { const hour = new Date().getHours(); const greetingEl = document.getElementById('greeting'); if (hour < 12) greetingEl.textContent = 'Buenos días.'; else if (hour < 19) greetingEl.textContent = 'Buenas tardes.'; else greetingEl.textContent = 'Buenas noches.'; },
                renderView() { const currentView = App.state.currentView; document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(currentView)?.classList.add('active'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); const activeLink = document.querySelector(`.nav-link[data-view="${currentView}"]`); if(activeLink) activeLink.classList.add('active'); const tasksNavItem = document.getElementById('tasks-nav-item'); if (currentView === 'tasks-view') { tasksNavItem.classList.add('expanded'); } else { tasksNavItem.classList.remove('expanded'); } },
                renderDashboard() { const todayTaskCount = App.dataManager.getTasksForDate(new Date()).filter(t=>!t.completed).length; document.getElementById('task-summary').textContent = `Tienes ${todayTaskCount} tarea${todayTaskCount !== 1 ? 's' : ''} pendiente${todayTaskCount !== 1 ? 's' : ''} para hoy.`; const upNextItem = App.dataManager.getUpNextItem(); const upNextContainer = document.getElementById('up-next-container'); if (upNextItem) { upNextContainer.innerHTML = `<div class="up-next-timeline" style="background-color: ${upNextItem.color || 'var(--text-on-accent)'};"></div><div class="up-next-info"><h5>${upNextItem.name}</h5><p>${upNextItem.startTime} - ${upNextItem.endTime}</p></div>`; } else { upNextContainer.innerHTML = `<div class="up-next-info"><h5>Estás libre por ahora.</h5><p>¡Buen trabajo!</p></div>`; } document.getElementById('streak-display').textContent = `🔥 ${App.state.streak.count}`; this.fetchWeather(); const todayList = document.getElementById('today-tasks-list'); const upcomingList = document.getElementById('upcoming-tasks-list'); todayList.innerHTML = ''; upcomingList.innerHTML = ''; App.dataManager.getTasksForDate(new Date()).forEach(t => todayList.appendChild(this.createTaskElement(t, 'list-item'))); App.dataManager.getUpcomingTasks().forEach(t => upcomingList.appendChild(this.createTaskElement(t, 'list-item'))); if (todayList.innerHTML === '') todayList.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:10px;">¡Todo listo por hoy! ✨</p>'; if (upcomingList.innerHTML === '') upcomingList.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:10px;">No hay tareas próximas.</p>'; this.renderPomodoro(); this.renderHabitTracker(); this.renderTodaySchedule(); },
                renderTasksView() { const container = document.getElementById('tasks-view-container'); container.innerHTML = ''; const { category, searchTerm } = App.state.taskFilters; document.getElementById('tasks-view-title').textContent = {all: "Tareas y Exámenes", Tareas: "Tareas", Exámenes: "Exámenes"}[category] || "Tareas y Exámenes"; let filteredTasks = App.state.tasks; if (category !== 'all') { filteredTasks = filteredTasks.filter(t => t.type === category); } if (searchTerm) { filteredTasks = filteredTasks.filter(t => t.title.toLowerCase().includes(searchTerm)); } const todayStr = new Date().toISOString().split('T')[0]; const today = new Date(todayStr); const sections = { today: [], upcoming: [], completed: [] }; filteredTasks.forEach(task => { if (task.completed) { sections.completed.push(task); } else { const dueDate = new Date(task.dueDate); if (task.dueDate === todayStr || dueDate < today) { sections.today.push(task); } else { sections.upcoming.push(task); } } }); const renderSection = (title, tasks) => { if (tasks.length > 0) { const tasksHTML = tasks.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).map(t => this.createTaskElement(t, 'card').outerHTML).join(''); container.innerHTML += `<div class="tasks-section"><h3 class="tasks-section-header">${title}</h3><div class="tasks-container">${tasksHTML}</div></div>`; } }; renderSection('Hoy y Atrasadas', sections.today); renderSection('Próximas', sections.upcoming); renderSection('Completadas', sections.completed); if (container.innerHTML.trim() === '') { container.innerHTML = `<p style="color:var(--text-secondary); text-align:center; padding:20px;">No se encontraron tareas con los filtros actuales.</p>`; } },
                renderClassesView() { const grid = document.getElementById('classes-grid-container'); grid.innerHTML = ''; if (App.state.classes.length === 0) { grid.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:20px;">Crea tu primera clase para empezar.</p>'; return; } App.state.classes.forEach(c => grid.appendChild(this.createClassElement(c))); },
                renderCalendar() { const calBody = document.getElementById('calendar-body'); calBody.innerHTML = ''; const calHeader = document.getElementById('calendar-header-days'); calHeader.innerHTML = ''; ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].forEach(day => calHeader.innerHTML += `<div class="calendar-day-name">${day}</div>`); const date = App.state.calendar.date; document.getElementById('calendar-month-year').textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }); const month = date.getMonth(), year = date.getFullYear(); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < firstDay; i++) calBody.innerHTML += `<div class="calendar-day not-current-month"></div>`; for (let i = 1; i <= daysInMonth; i++) { const dayCell = document.createElement('div'); const thisDate = new Date(year, month, i); const thisDateStr = thisDate.toISOString().split('T')[0]; dayCell.className = 'calendar-day'; if(thisDate.toDateString() === new Date().toDateString()) dayCell.classList.add('today'); const vacation = App.state.vacations.find(v => thisDateStr >= v.startDate && thisDateStr <= v.endDate); if(vacation && thisDateStr === vacation.startDate) { dayCell.innerHTML += `<div class="calendar-vacation-bar">${vacation.name}</div>`; } dayCell.innerHTML += `<div class="day-number">${i}</div><div class="calendar-events"></div>`; const eventsContainer = dayCell.querySelector('.calendar-events'); App.dataManager.getTasksForDate(thisDate).forEach(task => { const taskEl = document.createElement('div'); taskEl.className = 'calendar-event-item'; taskEl.textContent = task.title; const cls = App.dataManager.getClass(task.classId); taskEl.style.backgroundColor = cls ? cls.color : '#888'; eventsContainer.appendChild(taskEl); }); calBody.appendChild(dayCell); } },
                renderTodaySchedule() { const timeline = document.getElementById('schedule-timeline-content'); if (!timeline) return; timeline.innerHTML = ''; const todayIndex = (new Date().getDay() + 6) % 7; const timelineStartHour = 6; const timelineEndHour = 22; const totalTimelineMinutes = (timelineEndHour - timelineStartHour) * 60; const timeToMinutes = (timeStr) => { if(!timeStr) return 0; const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; }; App.state.classes.forEach(cls => { (cls.schedule || []).forEach(slot => { if (parseInt(slot.day, 10) === todayIndex) { const startMinutes = timeToMinutes(slot.startTime); const endMinutes = timeToMinutes(slot.endTime); const left = ((startMinutes - (timelineStartHour * 60)) / totalTimelineMinutes) * 100; const width = ((endMinutes - startMinutes) / totalTimelineMinutes) * 100; if (width > 0 && left < 100 && left + width > 0) { const eventEl = document.createElement('div'); eventEl.className = 'schedule-event'; eventEl.style.left = `${Math.max(0, left)}%`; eventEl.style.width = `${width}%`; eventEl.style.backgroundColor = cls.color; eventEl.title = `${cls.name}\n${slot.startTime} - ${slot.endTime}`; timeline.appendChild(eventEl); } } }); }); },
                renderPomodoro() { const { timeLeft, isRunning, sessions } = App.state.pomodoro; const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0'); const seconds = String(timeLeft % 60).padStart(2, '0'); document.getElementById('pomodoro-display').textContent = `${minutes}:${seconds}`; this.updatePomodoroStroke(App.state.pomodoro.progressColor); const progressCircle = document.getElementById('pomodoro-progress'); const radius = progressCircle.r.baseVal.value; const circumference = 2 * Math.PI * radius; const totalDuration = (App.state.pomodoro.isBreak ? App.state.pomodoro.settings.break : App.state.pomodoro.settings.focus) * 60; const progress = timeLeft / totalDuration; const offset = circumference * (1 - progress); progressCircle.style.strokeDasharray = circumference; progressCircle.style.strokeDashoffset = offset; const toggleBtn = document.getElementById('pomodoro-toggle-btn'); toggleBtn.classList.toggle('is-running', isRunning); toggleBtn.innerHTML = isRunning ? `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>` : `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>`; document.getElementById('pomodoro-session-display').textContent = `Sesión ${sessions.current} / ${sessions.goal}`; },
                updatePomodoroStroke(colorValue) { const progressCircle = document.getElementById('pomodoro-progress'); if (colorValue && colorValue.startsWith('gradient:')) { const colors = colorValue.replace('gradient:', '').split(','); document.getElementById('pomodoro-grad-stop1').setAttribute('stop-color', colors[0]); document.getElementById('pomodoro-grad-stop2').setAttribute('stop-color', colors[1]); progressCircle.style.stroke = 'url(#pomodoro-gradient-dynamic)'; } else { progressCircle.style.stroke = colorValue || '#FFFFFF'; } },
                renderHabitTracker() { const container = document.getElementById('habit-list-container'); container.innerHTML = ''; App.state.habits.forEach(habit => { const row = document.createElement('div'); row.className = 'habit-row'; let weekHTML = ''; for (let i = 0; i < 7; i++) { weekHTML += `<div><input type="checkbox" id="h-${habit.id}-${i}" data-habit-id="${habit.id}" data-day="${i}" ${habit.completion[i] ? 'checked' : ''}><label for="h-${habit.id}-${i}" class="day-label">${['L','M','X','J','V','S','D'][i]}</label></div>`; } row.innerHTML = `<button class="delete-habit-btn" data-habit-id="${habit.id}" title="Eliminar hábito">🗑️</button><span class="habit-name">${habit.name}</span><div class="habit-week-tracker">${weekHTML}</div>`; container.appendChild(row); }); },
                createTaskElement(task, style) { const el = document.createElement('div'); const cls = App.dataManager.getClass(task.classId); const color = cls?.color || '#6A7383'; if (style === 'list-item') { el.className = 'task-list-item'; el.innerHTML = `<input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''}><div class="task-details"><span class="task-name ${task.completed ? 'completed' : ''}">${task.title}</span></div><span class="task-subject-tag" style="background-color: ${color};">${cls?.name || 'General'}</span>`; } else { el.className = 'task-card'; el.innerHTML = `<input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''}><div class="task-details"><span class="task-name ${task.completed ? 'completed' : ''}">${task.title}</span><div class="task-due-date">Vence: ${new Date(task.dueDate + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })} ${task.time || ''}</div></div><div class="task-tags-container"><span class="task-category-tag">${task.type || 'Tarea'}</span><span class="task-subject-tag" style="background-color: ${color};">${cls?.name || 'General'}</span></div><div class="task-actions"><button class="delete-btn edit-btn" data-task-id="${task.id}" data-action="edit">✏️</button><button class="delete-btn" data-task-id="${task.id}" data-action="delete">🗑️</button></div>`; } return el; },
                createClassElement(cls) { const card = document.createElement('div'); card.className = 'class-card'; card.style.backgroundColor = cls.color; card.innerHTML = `<h4>${cls.name}</h4><p>${cls.teacher || 'Sin profesor'}</p><div class="class-card-details">${cls.mode} | ${cls.room} ${cls.building}</div><div class="class-card-actions"><button class="class-action-btn" data-class-id="${cls.id}" data-action="edit">✏️</button><button class="class-action-btn" data-class-id="${cls.id}" data-action="delete">🗑️</button></div>`; return card; },
                openModal(id) { document.getElementById(id).classList.add('active'); },
                closeModal(id) { document.getElementById(id).classList.remove('active'); },
                prepareClassModal(id = null) { const form = document.getElementById('class-form'); form.reset(); document.getElementById('class-id').value = id || ''; document.getElementById('class-modal-title').textContent = id ? 'Editar Clase' : 'Nueva Clase'; const picker = document.getElementById('class-color-picker'); picker.innerHTML = App.state.classColorPalette.map(c => `<div class="color-option" style="background-color: ${c}" data-color-value="${c}"></div>`).join(''); const scheduleContainer = document.getElementById('schedule-container'); scheduleContainer.innerHTML = ''; if (id) { const c = App.dataManager.getClass(id); document.getElementById('class-name').value = c.name; document.getElementById('class-teacher').value = c.teacher; document.getElementById('class-room').value = c.room; document.getElementById('class-building').value = c.building; document.getElementById('class-mode').value = c.mode; picker.querySelector(`[data-color-value="${c.color}"]`)?.classList.add('selected'); (c.schedule || []).forEach(slot => this.addScheduleRow(slot.day, slot.startTime, slot.endTime)); } else { picker.querySelector('.color-option')?.classList.add('selected'); } this.openModal('class-modal'); },
                prepareTaskModal(id = null, type = 'Tareas') { const form = document.getElementById('task-form'); form.reset(); document.getElementById('task-id').value = id || ''; document.getElementById('task-type-hidden').value = type; document.getElementById('task-modal-title').textContent = id ? `Editar ${type}` : `Nueva ${type}`; const classSelect = document.getElementById('task-class'); classSelect.innerHTML = '<option value="general" selected>General</option>' + App.state.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); if(id) { const t = App.dataManager.getTask(id); document.getElementById('task-title').value = t.title; document.getElementById('task-details').value = t.details; document.getElementById('task-due-date').value = t.dueDate; document.getElementById('task-time').value = t.time; classSelect.value = t.classId; } else { document.getElementById('task-due-date').valueAsDate = new Date(); } this.openModal('task-modal'); },
                prepareVacationModal(id = null) { const form = document.getElementById('vacation-form'); form.reset(); const preview = document.getElementById('vacation-photo-preview'); preview.style.display = 'none'; preview.src = ''; document.getElementById('vacation-id').value = id || ''; this.openModal('vacation-modal'); },
                addScheduleRow(day = '0', start = '09:00', end = '10:00') { const container = document.getElementById('schedule-container'); const row = document.createElement('div'); row.className = 'schedule-entry'; row.innerHTML = `<select class="schedule-day">${['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'].map((d,i) => `<option value="${i}" ${i == day ? 'selected' : ''}>${d}</option>`).join('')}</select><input type="time" class="schedule-start" value="${start}"><span>-</span><input type="time" class="schedule-end" value="${end}"><button type="button" class="delete-btn" data-action="delete-schedule-row">🗑️</button>`; container.appendChild(row); },
                renderProfilePic() { const pic = document.getElementById('profile-pic'); if (App.state.profilePic) { pic.src = App.state.profilePic; } },
                renderNoteList(){ const listEl = document.getElementById('notes-list'); listEl.innerHTML = ''; App.state.notes.sort((a,b) => b.lastModified - a.lastModified).forEach(note => { const li = document.createElement('li'); li.className = `note-list-item ${note.id === App.state.activeNoteId ? 'active' : ''}`; li.dataset.id = note.id; li.innerHTML = `<div class="note-list-item-title">${note.title || 'Sin título'}</div><div class="note-list-item-date">${new Date(note.lastModified).toLocaleString('es-ES')}</div><button id="delete-note-btn" data-id="${note.id}" data-action="delete-note">🗑️</button>`; listEl.appendChild(li); }); },
                renderNoteEditor(){ const editorPanel = document.getElementById('note-editor-panel'); const note = App.state.notes.find(n => n.id === App.state.activeNoteId); if(note){ editorPanel.innerHTML = `<input type="text" id="active-note-title" placeholder="Título de la nota..." value="${note.title}"><textarea id="active-note-content" placeholder="Escribe aquí...">${note.content}</textarea>`; } else { editorPanel.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding: 20px;">Selecciona una nota o crea una nueva.</div>'; } },
                prepareNotepad() { this.renderNoteList(); this.renderNoteEditor(); this.openModal('notepad-modal'); },

                setupEventListeners() {
                    document.body.addEventListener('click', e => {
                        const target = e.target;
                        const navLink = target.closest('.nav-link'); if (navLink) { e.preventDefault(); if (navLink.dataset.view) { App.state.currentView = navLink.dataset.view; this.renderAll(); } else if(navLink.classList.contains('theme-toggle-btn')) { App.state.theme = App.state.theme === 'light' ? 'dark' : 'light'; App.dataManager.save(); this.applyTheme(); } else if (navLink.id === 'open-notepad-btn') this.prepareNotepad(); else if (navLink.id === 'open-horoscope-btn') this.showHoroscope(); }
                        if (target.closest('.close-modal-btn')) this.closeModal(target.closest('.close-modal-btn').dataset.modalId);
                        if (target.matches('.modal-overlay')) this.closeModal(target.id);
                        if (target.closest('[id^="add-item-btn-"]')) { this.openModal('add-item-menu'); }
                        
                        // Add item menu logic
                        if (target.closest('#add-new-btn-from-menu')) {
                            const selectedType = document.querySelector('.add-item-option.selected')?.dataset.itemType;
                            this.closeModal('add-item-menu');
                            if (selectedType === 'task') this.prepareTaskModal(null, 'Tareas');
                            else if (selectedType === 'exam') this.prepareTaskModal(null, 'Exámenes');
                            else if (selectedType === 'class') this.prepareClassModal();
                            else if (selectedType === 'vacation') this.prepareVacationModal();
                            else if (selectedType === 'xtra') alert("Función Premium Próximamente!");
                        }
                        const addItemOption = target.closest('.add-item-option'); if(addItemOption) { document.querySelectorAll('.add-item-option').forEach(opt => opt.classList.remove('selected')); addItemOption.classList.add('selected'); }
                        
                        if (target.closest('#pomodoro-settings-btn')) this.preparePomodoroSettingsModal();
                        if (target.closest('#pomodoro-toggle-btn')) this.pomodoro.toggle();
                        if (target.closest('#pomodoro-reset-btn')) this.pomodoro.reset();
                        
                        const classActionBtn = target.closest('.class-action-btn'); if (classActionBtn) { const id = classActionBtn.dataset.classId; if (classActionBtn.dataset.action === 'edit') this.prepareClassModal(id); if (classActionBtn.dataset.action === 'delete') if (confirm('¿Seguro?')) { App.dataManager.deleteClass(id); this.renderAll(); } }
                        if(target.closest('#add-schedule-btn')) this.addScheduleRow();
                        if(target.dataset.action === 'delete-schedule-row') target.closest('.schedule-entry').remove();
                        if (target.matches('.task-checkbox')) { App.dataManager.toggleTask(target.dataset.id); this.renderDashboard(); this.renderTasksView(); }
                        
                        const taskActionBtn = target.closest('.delete-btn[data-task-id]'); if(taskActionBtn) { const id = taskActionBtn.dataset.taskId; const task = App.dataManager.getTask(id); if (taskActionBtn.dataset.action === 'edit') this.prepareTaskModal(id, task.type); if (taskActionBtn.dataset.action === 'delete') if (confirm('¿Eliminar?')) { App.dataManager.deleteTask(id); this.renderAll(); } }
                        
                        const deleteHabitBtn = target.closest('.delete-habit-btn'); if (deleteHabitBtn) { const habitId = deleteHabitBtn.dataset.habitId; if (confirm('¿Eliminar?')) { App.dataManager.deleteHabit(habitId); this.renderHabitTracker(); } }
                        const filterLink = target.closest('.filter-link'); if (filterLink) { document.querySelectorAll('#tasks-nav-item .filter-link').forEach(link => link.classList.remove('active')); filterLink.classList.add('active'); App.state.taskFilters.category = filterLink.dataset.category; this.renderTasksView(); }
                        if (target.closest('[data-view-target]')) { App.state.currentView = target.closest('[data-view-target]').dataset.viewTarget; this.renderAll(); }

                        if(target.closest('#new-note-btn')) { App.dataManager.addNote(); this.renderNoteList(); this.renderNoteEditor(); }
                        const noteItem = target.closest('.note-list-item'); if(noteItem && !target.closest('#delete-note-btn')) { App.state.activeNoteId = noteItem.dataset.id; this.renderNoteList(); this.renderNoteEditor(); }
                        if(target.dataset.action === 'delete-note') { const id = target.dataset.id; App.dataManager.deleteNote(id); this.renderNoteList(); this.renderNoteEditor(); }
                    });

                    document.getElementById('class-form').addEventListener('submit', e => { e.preventDefault(); const schedule = Array.from(document.querySelectorAll('#schedule-container .schedule-entry')).map(row => ({ day: row.querySelector('.schedule-day').value, startTime: row.querySelector('.schedule-start').value, endTime: row.querySelector('.schedule-end').value })); const classData = { id: document.getElementById('class-id').value, name: document.getElementById('class-name').value, teacher: document.getElementById('class-teacher').value, room: document.getElementById('class-room').value, building: document.getElementById('class-building').value, mode: document.getElementById('class-mode').value, color: document.querySelector('#class-color-picker .selected').dataset.colorValue, schedule }; classData.id ? App.dataManager.updateClass(classData) : App.dataManager.addClass(classData); this.closeModal('class-modal'); this.renderAll(); });
                    document.getElementById('task-form').addEventListener('submit', e => { e.preventDefault(); const taskData = { id: document.getElementById('task-id').value, type: document.getElementById('task-type-hidden').value, title: document.getElementById('task-title').value, details: document.getElementById('task-details').value, dueDate: document.getElementById('task-due-date').value, time: document.getElementById('task-time').value, classId: document.getElementById('task-class').value }; taskData.id ? App.dataManager.updateTask(taskData) : App.dataManager.addTask(taskData); this.closeModal('task-modal'); this.renderAll(); });
                    document.getElementById('vacation-form').addEventListener('submit', e => { e.preventDefault(); const vacationData = { id: document.getElementById('vacation-id').value, name: document.getElementById('vacation-name').value, details: document.getElementById('vacation-details').value, startDate: document.getElementById('vacation-start-date').value, endDate: document.getElementById('vacation-end-date').value, photo: document.getElementById('vacation-photo-preview').src }; vacationData.id ? App.dataManager.updateVacation(vacationData) : App.dataManager.addVacation(vacationData); this.closeModal('vacation-modal'); this.renderAll(); });
                    document.getElementById('note-editor-panel').addEventListener('input', e => { if(App.state.activeNoteId) { const title = document.getElementById('active-note-title').value; const content = document.getElementById('active-note-content').value; clearTimeout(App.ui.noteRenderTimeout); App.ui.noteRenderTimeout = setTimeout(() => { App.dataManager.updateNote(App.state.activeNoteId, {title, content}); App.ui.renderNoteList(); }, 300); } });
                    document.getElementById('class-color-picker').addEventListener('click', e => { if (e.target.classList.contains('color-option')) { document.querySelectorAll('#class-color-picker .color-option').forEach(el => el.classList.remove('selected')); e.target.classList.add('selected'); } });
                    document.getElementById('pfp-upload').addEventListener('change', e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { App.state.profilePic = event.target.result; this.renderProfilePic(); App.dataManager.save(); }; reader.readAsDataURL(file); });
                    document.getElementById('sidebar-search').addEventListener('input', e => { App.state.taskFilters.searchTerm = e.target.value.toLowerCase(); this.renderTasksView(); });
                    document.getElementById('vacation-photo-upload-area').addEventListener('click', () => document.getElementById('vacation-photo-input').click());
                    document.getElementById('vacation-photo-input').addEventListener('change', e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { const preview = document.getElementById('vacation-photo-preview'); preview.src = event.target.result; preview.style.display = 'block'; }; reader.readAsDataURL(file); } });
                    document.getElementById('cal-prev-btn').addEventListener('click', () => {App.state.calendar.date.setMonth(App.state.calendar.date.getMonth() - 1); this.renderCalendar()});
                    document.getElementById('cal-next-btn').addEventListener('click', () => {App.state.calendar.date.setMonth(App.state.calendar.date.getMonth() + 1); this.renderCalendar()});
                },
                pomodoro: { toggle() { App.state.pomodoro.isRunning = !App.state.pomodoro.isRunning; if (App.state.pomodoro.isRunning) { App.state.pomodoro.intervalId = setInterval(() => this.tick(), 1000); } else { clearInterval(App.state.pomodoro.intervalId); } App.ui.renderPomodoro(); }, tick() { App.state.pomodoro.timeLeft--; if (App.state.pomodoro.timeLeft < 0) { this.finish(); } App.ui.renderPomodoro(); }, finish() { const { pomodoro } = App.state; clearInterval(pomodoro.intervalId); pomodoro.isRunning = false; document.getElementById('alert-sound').play(); if (!pomodoro.isBreak) { pomodoro.sessions.current++; if (pomodoro.sessions.current >= pomodoro.sessions.goal) { alert("¡Felicidades! Has completado tu meta de sesiones."); this.reset(); return; } } pomodoro.isBreak = !pomodoro.isBreak; this.reset(false, false); this.toggle(); }, reset(manual = true, stopTimer = true){ const { pomodoro } = App.state; if (stopTimer) { clearInterval(pomodoro.intervalId); pomodoro.isRunning = false; } if (manual) { pomodoro.isBreak = false; pomodoro.sessions.current = 0; } pomodoro.timeLeft = (pomodoro.isBreak ? pomodoro.settings.break : pomodoro.settings.focus) * 60; App.ui.renderPomodoro(); } },
                showHoroscope() { const horoscopes = [ { emoji: "♈", quote: "Una ráfaga de energía te encuentra hoy. ¡Canalízala en un proyecto que te apasione!" }, { emoji: "♉", quote: "La paciencia es tu aliada. Un enfoque lento y constante conducirá al dulce éxito." }, { emoji: "♊", quote: "Tu curiosidad es tu superpoder. Haz preguntas y explora una nueva idea." }]; const {emoji, quote} = horoscopes[Math.floor(Math.random() * horoscopes.length)]; document.getElementById('horoscope-emoji').textContent = emoji; document.getElementById('horoscope-text').textContent = quote; this.openModal('horoscope-modal'); },
                async fetchWeather() { document.getElementById('weather-display').textContent = `29°`; document.getElementById('weather-city').textContent = `Kissimmee, FL`; }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.dataManager.load();
            App.dataManager.updateStreak();
            App.dataManager.resetWeeklyHabits();
            App.ui.init();
        });
    })();
    </script>
</body>
</html>