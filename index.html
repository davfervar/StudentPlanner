<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Student Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ==========================================================================
           1. THEME & CORE STYLES
           ========================================================================== */
        :root {
            --bg-main-light: #F7F8FC;
            --bg-sidebar-light: #FFFFFF;
            --bg-widget-light: #FFFFFF;
            --bg-input-light: #F0F2F5;
            --bg-hover-light: #EAEFFC;
            --bg-accent-light: #4A69FF;
            --bg-accent-hover-light: #3b54cc;

            --text-primary-light: #1A1C20;
            --text-secondary-light: #6A7383;
            --text-accent-light: #4A69FF;
            --text-on-accent-light: #FFFFFF;

            --border-light: #E8EBF1;
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.04);
            --danger-light: #e74c3c;
            --warning-light: #f39c12;
            --info-light: #3498db;
            --success-light: #06D6A0;

            --hero-gradient-light: linear-gradient(180deg, #8EACE5 0%, #B6CCF5 100%);

            --bg-main-dark: #121212;
            --bg-sidebar-dark: #1A1A1A;
            --bg-widget-dark: #1E1E1E;
            --bg-input-dark: #2C2C2C;
            --bg-hover-dark: #2F2F2F;
            --bg-accent-dark: #5D78FF;
            --bg-accent-hover-dark: #4a60cc;

            --text-primary-dark: #EAEAEA;
            --text-secondary-dark: #9A9A9A;
            --text-accent-dark: #5D78FF;
            --text-on-accent-dark: #FFFFFF;

            --border-dark: #303030;
            --shadow-dark: 0 5px 20px rgba(0, 0, 0, 0.25);
            --danger-dark: #ff5252;
            --warning-dark: #f5ab4b;
            --info-dark: #5dade2;
            --success-dark: #2ecc71;

            --hero-gradient-dark: linear-gradient(120deg, #0f2027 0%, #203a43 100%);

            --bg-main: var(--bg-main-light);
            --bg-sidebar: var(--bg-sidebar-light);
            --bg-widget: var(--bg-widget-light);
            --bg-input: var(--bg-input-light);
            --bg-hover: var(--bg-hover-light);
            --bg-accent: var(--bg-accent-light);
            --bg-accent-hover: var(--bg-accent-hover-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --text-accent: var(--text-accent-light);
            --text-on-accent: var(--text-on-accent-light);
            --border-color: var(--border-light);
            --shadow: var(--shadow-light);
            --danger: var(--danger-light);
            --warning: var(--warning-light);
            --info: var(--info-light);
            --success: var(--success-light);
            --hero-gradient: var(--hero-gradient-light);
        }

        body.dark-mode {
            --bg-main: var(--bg-main-dark);
            --bg-sidebar: var(--bg-sidebar-dark);
            --bg-widget: var(--bg-widget-dark);
            --bg-input: var(--bg-input-dark);
            --bg-hover: var(--bg-hover-dark);
            --bg-accent: var(--bg-accent-dark);
            --bg-accent-hover: var(--bg-accent-hover-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --text-accent: var(--text-accent-dark);
            --text-on-accent: var(--text-on-accent-dark);
            --border-color: var(--border-dark);
            --shadow: var(--shadow-dark);
            --danger: var(--danger-dark);
            --warning: var(--warning-dark);
            --info: var(--info-dark);
            --success: var(--success-dark);
            --hero-gradient: var(--hero-gradient-dark);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        /* ==========================================================================
           2. LAYOUT & SIDEBAR
           ========================================================================== */
        .sidebar {
            width: 260px; height: 100vh; background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; flex-shrink: 0;
            position: fixed; z-index: 100;
        }
        .sidebar-header {
            padding: 20px 20px 0 20px;
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 20px; flex-shrink: 0;
        }

        .profile-pic {
            width: 40px; height: 40px; border-radius: 50%;
            background-color: var(--bg-input); object-fit: cover;
            border: 2px solid var(--border-color);
            transition: transform 0.2s, border-color 0.2s;
        }
        .profile-pic:hover { transform: scale(1.1); border-color: var(--text-accent); }

        .sidebar-header h1 { font-size: 1.2rem; font-weight: 600; }

        .sidebar-top-controls {
            flex-shrink: 0;
            padding: 0 20px;
        }

        .main-nav { 
            flex-grow: 1; 
            overflow-y: auto; 
            -ms-overflow-style: none; 
            scrollbar-width: none;
            padding: 0 20px;
            min-height: 0;
        }
        .main-nav::-webkit-scrollbar { display: none; }

        .nav-section { margin-bottom: 25px; }
        .nav-section-title {
            font-size: 0.75rem; text-transform: uppercase; font-weight: 600;
            color: var(--text-secondary); padding: 0 0 10px 0;
        }
        .nav-link, .filter-link {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            border-radius: 8px; text-decoration: none; color: var(--text-secondary);
            font-weight: 500; transition: all 0.2s; margin: 4px 0;
            cursor: pointer; border: none; background: none; width: 100%; text-align: left;
        }
        .nav-link:hover, .filter-link:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .nav-link.active, .filter-link.active { background-color: var(--bg-accent); color: var(--text-on-accent); font-weight: 600; }
        .nav-icon { font-size: 1.2rem; }

        .search-container { 
            position: relative;
        }
        #sidebar-search {
            width: 100%; padding: 10px 10px 10px 35px; border-radius: 8px;
            border: 1px solid var(--border-color); background-color: var(--bg-input);
            color: var(--text-primary); font-size: 0.9rem;
        }
        #sidebar-search:focus { outline: none; border-color: var(--text-accent); }
        .search-container::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1rem;
        }

        #open-add-new-modal-btn { width: 100%; margin-top: 15px; }

        #task-filter-nav {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease-in-out, padding-top 0.35s ease-in-out, padding-bottom 0.35s ease-in-out;
            padding-left: 28px;
            margin: 0;
        }
        #task-filter-nav.open {
            max-height: 350px;
            padding-top: 4px;
            padding-bottom: 8px;
        }
        #task-filter-nav .filter-link {
            padding-top: 8px; padding-bottom: 8px; font-size: 0.9rem;
        }
        #task-filter-nav .filter-link .nav-icon { font-size: 1.1rem; }

        .sidebar-footer {
            flex-shrink: 0;
            padding: 15px 20px 20px 20px;
            border-top: 1px solid var(--border-color);
        }

        .app-container {
            flex-grow: 1; margin-left: 260px; display: flex;
            flex-direction: column; height: 100vh;
        }

        .main-content { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ==========================================================================
           3. SHARED COMPONENTS & DASHBOARD HERO
           ========================================================================== */
        .hero-banner {
            background: var(--hero-gradient); border-radius: 12px;
            padding: 30px; margin-bottom: 25px; position: relative;
            color: var(--text-on-accent);
            overflow: hidden; box-shadow: var(--shadow);
        }
       
        .hero-banner h2 { font-size: 2.5rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .hero-banner p { font-size: 1rem; opacity: 0.9; margin-top: 5px; text-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .up-next-card {
            position: absolute; right: 30px; top: 50%;
            transform: translateY(-50%); background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px); border-radius: 12px; padding: 20px;
            width: 280px; border: 1px solid rgba(255,255,255,0.4);
            color: var(--text-on-accent);
        }
        body.dark-mode .up-next-card {
            background: rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        .up-next-card h4 {
            font-size: 0.8rem; font-weight: 600; text-transform: uppercase;
            opacity: 0.8; margin-bottom: 10px;
        }
        .up-next-details { display: flex; align-items: center; gap: 12px; }
        .up-next-timeline {
            width: 3px; height: 40px; background: var(--text-on-accent);
            border-radius: 2px; opacity: 0.8;
        }

        .up-next-info h5 { font-size: 1.1rem; font-weight: 600; }
        .up-next-info p { font-size: 0.9rem; opacity: 0.8; margin-top: 2px; }

        .primary-btn {
            padding: 10px 18px; background-color: var(--bg-accent);
            color: var(--text-on-accent); border: none; border-radius: 8px;
            cursor: pointer; font-weight: 600; font-size: 0.9rem;
            transition: background-color 0.2s, transform 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .primary-btn:hover { background-color: var(--bg-accent-hover); transform: translateY(-2px); }
        .primary-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; transform: none; }
       
        .danger-btn { background-color: var(--danger); color: white; }
        .danger-btn:hover { background-color: color-mix(in srgb, var(--danger) 85%, #000); }
        .danger-btn:disabled { background-color: color-mix(in srgb, var(--danger) 50%, #888); cursor: not-allowed; transform: none; }

        .secondary-btn {
            padding: 10px 18px; background-color: var(--bg-input);
            color: var(--text-primary); border: 1px solid var(--border-color);
            border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.9rem;
            transition: background-color 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .secondary-btn:hover { background-color: var(--border-color); }
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px;
        }
        .page-header h2 { font-size: 1.8rem; font-weight: 700; }
        .page-header .header-actions { display: flex; align-items:center; gap: 10px; }

        .widget {
            background-color: var(--bg-widget); border-radius: 12px;
            border: 1px solid var(--border-color); padding: 20px;
            box-shadow: var(--shadow); transition: all 0.3s;
        }
        .widget-header {
             display: flex; justify-content: space-between; align-items: center;
             margin-bottom: 15px;
        }
        .widget-header h3 { font-size: 1.1rem; font-weight: 600; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; animation: fadeInModal 0.3s ease;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background-color: var(--bg-widget); padding: 25px;
            border-radius: 12px; box-shadow: var(--shadow-dark);
            width: 90%; max-width: 500px;
            animation: popInModal 0.3s ease-out;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-body { overflow-y: auto; padding-right: 15px; margin-right: -15px;}
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px; flex-shrink: 0;
        }
        .modal-header h3 { font-size: 1.3rem; }
        .close-modal-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block; font-weight: 500; margin-bottom: 8px;
            font-size: 0.9rem; color: var(--text-secondary);
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid var(--border-color); background-color: var(--bg-input);
            color: var(--text-primary); font-size: 1rem; font-family: 'Inter', sans-serif;
            resize: vertical;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--text-accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--bg-accent) 25%, transparent);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popInModal { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .add-new-form { display: none; }
        .add-new-form.active { display: block; animation: fadeIn 0.3s ease; }
        .photo-upload-container {
            width: 120px; height: 120px; border-radius: 8px; border: 2px dashed var(--border-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; background-color: var(--bg-input); color: var(--text-secondary);
            text-align: center; transition: border-color 0.2s; position: relative; overflow: hidden;
        }
        .photo-upload-container:hover { border-color: var(--text-accent); }
        .photo-upload-container .plus-icon { font-size: 2rem; font-weight: 200; }
        .photo-upload-container span { font-size: 0.8rem; margin-top: 5px; }
        #vacation-photo-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #vacation-photo-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center;}

        /* ==========================================================================
           4. DASHBOARD VIEW & WIDGETS
           ========================================================================== */
        #dashboard-view .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .dashboard-main, .dashboard-side { display: flex; flex-direction: column; gap: 25px; }
        .tasks-overview h4 { font-size: 1.2rem; margin-bottom: 15px; }
        .task-list-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 5px; border-bottom: 1px solid var(--border-color);
            border-radius: 6px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .task-list-item:hover {
            background-color: var(--bg-hover);
        }
        .task-list-item:last-child { border-bottom: none; }
        .task-checkbox { width: 18px; height: 18px; accent-color: var(--bg-accent); flex-shrink: 0; cursor: pointer; }
        .task-details { flex-grow: 1; }
        .task-details .task-name { font-weight: 500; }
        .task-details .task-name.completed { text-decoration: line-through; color: var(--text-secondary); }
        .task-subject-tag {
            font-size: 0.75rem; font-weight: 600; padding: 3px 8px;
            border-radius: 12px; color: white;
        }

        .pomodoro-widget {
            text-align: center;
            background: var(--hero-gradient);
            color: var(--text-on-accent);
            overflow: hidden;
            padding-bottom: 15px;
            cursor: pointer;
            position: relative;
        }
        
        .pomodoro-widget .pomodoro-control-btn[data-action="settings"] {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
        }
        
        .pomodoro-widget .pomodoro-control-btn[data-action="settings"] svg {
            width: 18px;
            height: 18px;
        }

        .pomodoro-widget h3 { color: inherit; opacity: 0.9; font-weight: 600; font-size: 1.1rem; }
        .pomodoro-widget .timer-visual { position: relative; width: 140px; height: 140px; margin: 10px auto 5px auto; }
        .pomodoro-widget .timer-visual > svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .pomodoro-widget .timer-circle-bg { fill: none; stroke: rgba(255, 255, 255, 0.25); stroke-width: 10; }

        .pomodoro-widget .timer-circle-progress {
            fill: none; stroke: var(--text-on-accent); stroke-width: 10; stroke-linecap: round;
            transition: stroke-dashoffset 1s linear, stroke 0.5s ease;
        }
       
        .pomodoro-widget #pomodoro-display {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 2.2rem;
            font-weight: 600; color: inherit; letter-spacing: 1px;
        }
        #pomodoro-session-display {
            font-size: 0.9rem; font-weight: 500; color: inherit;
            opacity: 0.8; margin-bottom: 10px;
        }
        .pomodoro-widget .pomodoro-controls { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .pomodoro-control-btn {
            background-color: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--text-on-accent);
            border-radius: 50%;
            width: 40px; height: 40px; cursor: pointer;
            display: grid; place-items: center; transition: all 0.2s ease-out;
            pointer-events: all;
        }
       
        .pomodoro-control-btn:hover { background-color: rgba(255,255,255,0.4); transform: scale(1.1); }
        .pomodoro-control-btn svg { width: 20px; height: 20px; fill: currentColor; transform: none; }


        .habit-tracker-widget #habit-list-container {
            display: flex; flex-direction: column; gap: 12px;
            max-height: 250px; overflow-y: auto; padding-right: 5px;
        }
        #new-habit-btn { width: 100%; margin-top: 15px; }
        .habit-row { display: flex; align-items: center; gap: 10px; position: relative; }
        .habit-row-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;}
        .habit-row:hover .habit-row-actions { opacity: 1; }
        .habit-action-btn { background: none; border: none; color: var(--text-secondary); font-size: 1rem; cursor: pointer; padding: 2px;}
        .habit-action-btn:hover { color: var(--danger); }
        .habit-action-btn[data-action="edit-habit"]:hover { color: var(--text-accent); }
        .habit-name { flex-grow: 1; font-size: 0.9rem; font-weight: 500; cursor: pointer; padding: 4px 0; }
        .habit-name:hover { color: var(--text-accent); }
        .habit-name-input {
            flex-grow: 1; font-size: 0.9rem; font-weight: 500;
            border: none; background-color: var(--bg-input); padding: 4px 6px;
            border-radius: 4px; outline-color: var(--text-accent);
        }
        .habit-week-tracker { display: flex; gap: 5px; }
        .day-label {
            width: 28px; height: 28px; border-radius: 50%;
            display: grid; place-items: center; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; border: 2px solid var(--border-color);
            color: var(--text-secondary); transition: all 0.2s;
        }
        .day-label.inactive {
            background-color: var(--bg-input);
            opacity: 0.5;
            cursor: not-allowed;
            color: var(--text-secondary);
        }
        .day-label.completed {
            background-color: var(--bg-accent); border-color: var(--bg-accent); color: var(--text-on-accent);
        }
        .day-label.partial {
             background-color: color-mix(in srgb, var(--bg-accent) 40%, transparent);
             border-color: var(--bg-accent);
             color: var(--text-accent);
        }
        body.dark-mode .day-label.partial { color: var(--text-on-accent); }

        .side-widget-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .side-widget {
            background: var(--bg-widget); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 15px; text-align: center;
            transition: all 0.2s ease;
        }
        .side-widget#streak-widget { cursor: pointer; }
        .side-widget#streak-widget:hover { transform: translateY(-3px); box-shadow: var(--shadow); }

        .side-widget-value { font-size: 1.5rem; font-weight: 700; color: var(--text-accent); }
        .side-widget-label { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-top: 5px; }
       
        #quick-add-container {
            margin-top: 15px;
            position: relative;
        }
        #quick-task-input {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid var(--border-color); background-color: var(--bg-input);
            color: var(--text-primary); font-size: 0.9rem;
        }
        #quick-task-input:focus { outline: none; border-color: var(--text-accent); }

        #quick-add-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .quick-add-btn {
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            background-color: var(--bg-input);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quick-add-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }
        .quick-add-btn.active {
            background-color: var(--bg-accent);
            color: var(--text-on-accent);
            border-color: var(--bg-accent);
        }

        #quick-add-subject-popover {
            display: none;
            position: absolute;
            bottom: 50px;
            left: 0;
            background-color: var(--bg-widget);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-dark);
            width: 200px;
            z-index: 1010;
            max-height: 200px;
            overflow-y: auto;
        }
        #quick-add-subject-popover ul {
            list-style: none;
            padding: 5px;
            margin: 0;
        }
        #quick-add-subject-popover li {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #quick-add-subject-popover li:hover {
            background-color: var(--bg-hover);
        }
        .subject-color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .schedule-widget h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        .schedule-timeline {
            position: relative; width: 100%; height: 24px;
            background-color: var(--bg-input); border-radius: 12px; overflow: hidden;
        }
        .schedule-event {
            position: absolute; top: 0; height: 100%;
            border-radius: 12px; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .schedule-event:hover { transform: scaleY(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .schedule-time-labels {
            display: flex; justify-content: space-between; padding: 8px 2px 0 2px;
            font-size: 0.75rem; color: var(--text-secondary); font-weight: 500;
        }

        /* ==========================================================================
           5. TASKS VIEW
           ========================================================================== */
        .tasks-section { margin-bottom: 30px; }
        .tasks-section-header {
            font-size: 1.5rem; font-weight: 600; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 1px solid var(--border-color);
        }
        #tasks-view .tasks-container { display: flex; flex-direction: column; gap: 12px; }
       
        .task-card {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            background-color: var(--bg-widget); border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease-out;
            cursor: pointer;
        }
        .task-card:hover { 
            box-shadow: var(--shadow); 
            border-color: var(--text-accent);
            transform: translateY(-2px);
        }
        .task-card.highlight {
            animation: highlight-task 2.5s ease-out;
        }
        @keyframes highlight-task {
            0% { 
                box-shadow: 0 0 0 4px color-mix(in srgb, var(--bg-accent) 25%, transparent);
                border-color: var(--text-accent);
            }
            80% { 
                box-shadow: 0 0 0 0px color-mix(in srgb, var(--bg-accent) 0%, transparent);
                border-color: var(--text-accent);
            }
            100% {
                border-color: var(--border-color);
            }
        }

        .task-card .task-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .task-card .task-details { flex-grow: 1; }
        .task-card .task-name { font-weight: 600; font-size: 1rem; }
        .task-card .task-name.completed {
            text-decoration: line-through; color: var(--text-secondary); font-weight: 500;
        }
        .task-card .task-due-date { 
            font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; font-weight: 500;
        }
        .task-tags-container {
            display: flex; align-items: center; gap: 8px;
            flex-shrink: 0; margin-left: auto;
        }
        .task-category-tag {
            font-size: 0.75rem; font-weight: 600; padding: 4px 10px;
            border-radius: 12px; background-color: var(--bg-input);
            color: var(--text-secondary); border: 1px solid var(--border-color);
        }
        .task-actions { display: flex; gap: 5px; }
        .delete-btn {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1rem; cursor: pointer; padding: 5px; border-radius: 50%;
            width: 32px; height: 32px; display: grid; place-items: center; transition: all 0.2s;
        }
        .delete-btn:hover { background-color: var(--bg-hover); color: var(--danger); }
        .edit-btn:hover { background-color: var(--bg-hover); color: var(--text-accent); }

        /* ==========================================================================
           6. SUBJECTS VIEW & MODAL
           ========================================================================== */
        .subjects-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;
        }
        .subject-card { 
            padding: 20px; 
            border-radius: 10px; 
            color: white; 
            position: relative; 
            transition: all 0.3s ease-out;
            cursor: pointer;
        }
         .subject-card.highlight {
            animation: highlight-subject 2.5s ease-out;
        }
        @keyframes highlight-subject {
            0%, 80% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 4px color-mix(in srgb, var(--bg-accent) 50%, transparent);
            }
            100% {
                transform: scale(1);
            }
        }
        .subject-card h4 { font-size: 1.2rem; margin-bottom: 5px; pointer-events:none; }
        .subject-card p { font-size: 0.9rem; opacity: 0.8; pointer-events:none; }
        .subject-card-actions {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;
        }
        .subject-action-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
            display: grid; place-items: center; transition: background 0.2s;
        }
        .subject-action-btn:hover { background: rgba(255,255,255,0.4); }
        .color-picker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .color-option {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: all 0.2s;
            position: relative; display: grid; place-items: center;
        }
        .color-option.selected { border-color: var(--bg-accent); transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .color-option::after {
            content: '‚úî'; color: #fff; font-size: 1.2rem;
            line-height: 1; text-shadow: 0 0 5px rgba(0,0,0,0.5);
            transform: scale(0); transition: transform 0.2s ease-out;
        }
        .color-option.selected::after { transform: scale(1); }
        .color-option[data-color-value^="#f"].selected::after { color: #000; text-shadow: none; }
        #pomodoro-color-presets { margin-bottom: 20px; }
        .custom-color-container { display: flex; align-items: center; gap: 15px; }
        #pomodoro-custom-color {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 44px; height: 44px; background-color: transparent;
            border: none; cursor: pointer; padding: 0;
        }
        #pomodoro-custom-color::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--border-color); }
         #pomodoro-custom-color::-moz-color-swatch { border-radius: 50%; border: 2px solid var(--border-color); }
        .schedule-entry { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }

        /* ==========================================================================
           7. CALENDAR VIEW - ENHANCED
           ========================================================================== */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; }
        .calendar-header h3 { font-size: 1.4rem; font-weight: 600; }
        .calendar-nav { display: flex; align-items: center; gap: 8px; }
        .calendar-grid-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-name { text-align: right; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); padding: 8px; }
        .calendar-day {
            min-height: 120px; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 8px;
            transition: border-color 0.2s; display: flex; flex-direction: column;
        }
        .calendar-day:hover { border-color: var(--text-accent); }
        .calendar-day.not-current-month { background-color: var(--bg-input); color: var(--text-secondary); }
        .day-number { text-align: right; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; cursor: pointer; }
        .calendar-day.today .day-number { color: var(--bg-accent); }
        .calendar-tasks { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .calendar-task-item, .calendar-class-item {
            font-size: 0.75rem; padding: 3px 6px; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            color: white; cursor: pointer;
            display: flex; align-items: center; gap: 4px;
        }
        .calendar-task-item .task-icon, .calendar-class-item .task-icon { font-size: 0.8em; }

        .calendar-more-indicator {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-accent);
            cursor: pointer;
            margin-top: 4px;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .calendar-more-indicator:hover { background-color: var(--bg-hover); }

        #calendar-tooltip {
            position: absolute;
            display: none;
            background-color: var(--bg-widget);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            z-index: 1050;
            width: 250px;
            box-shadow: var(--shadow-dark);
            pointer-events: none;
            transition: opacity 0.2s;
        }
        #calendar-tooltip h5 { font-size: 1rem; margin-bottom: 8px; }
        #calendar-tooltip p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }
        #calendar-tooltip p strong { color: var(--text-primary); }

        #day-view-modal .task-list-item { padding: 10px 0; }

        /* ==========================================================================
           8. SETTINGS, STREAK & TASK DETAIL
           ========================================================================== */
        .settings-layout { display: flex; gap: 25px; height: calc(100% - 40px); }
        .settings-nav {
            width: 220px; flex-shrink: 0;
            background-color: var(--bg-widget); border-radius: 12px; padding: 15px;
            border: 1px solid var(--border-color);
        }
        .settings-nav-link {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 8px; text-decoration: none; color: var(--text-secondary);
            font-weight: 500; transition: background-color 0.2s, color 0.2s; cursor: pointer;
        }
        .settings-nav-link:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .settings-nav-link.active { background-color: var(--bg-accent); color: var(--text-on-accent); font-weight: 600; }
        .settings-nav-link .nav-icon { font-size: 1.3rem; }

        .settings-content-wrapper {
            flex-grow: 1; 
            background-color: var(--bg-widget);
            border-radius: 12px; 
            padding: 25px 35px;
            border: 1px solid var(--border-color);
            overflow-y: auto;
        }
        .settings-content-pane { display: none; }
        .settings-content-pane.active { display: block; animation: fadeIn 0.5s ease; }
        .settings-content-pane h3 { font-size: 1.6rem; font-weight: 600; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
       
        .settings-section { margin-bottom: 40px; border-bottom: 1px solid var(--border-color); padding-bottom: 25px;}
        .settings-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .settings-section h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .settings-section p { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; max-width: 60ch; line-height: 1.6; }
       
        .profile-picture-setting { display: flex; align-items: center; gap: 20px; }
        .profile-picture-placeholder {
            width: 80px; height: 80px; border-radius: 50%;
            background-color: var(--bg-input); border: 2px dashed var(--border-color);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary);
        }
        .profile-picture-placeholder img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

        .confirmation-input-label {
            display: block; font-size: 0.9em; margin: 15px 0 8px 0;
            color: var(--text-secondary);
        }
        .confirmation-input-label strong {
            color: var(--danger); font-family: monospace;
            background-color: var(--bg-input); padding: 2px 6px; border-radius: 4px;
        }

        #delete-account-btn {
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: 600;
        }
       
        /* Tag Customization Styles */
        .tag-customize-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 8px; background-color: var(--bg-input); margin-bottom: 10px; }
        .tag-customize-item .tag-name { font-weight: 500; }
        .tag-customize-item .color-input-wrapper { display: flex; align-items: center; gap: 10px; }
        .tag-customize-item input[type="color"] { width: 40px; height: 40px; border: none; padding: 0; border-radius: 50%; cursor: pointer; background-color: transparent; }
        .tag-customize-item input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .tag-customize-item input[type="color"]::-webkit-color-swatch { border: 2px solid var(--border-color); border-radius: 50%; }

        /* Subscription Section Styles */
        .subscription-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;}
        .subscription-card { border: 2px solid var(--border-color); border-radius: 12px; padding: 25px; text-align: center; transition: all .3s ease; }
        .subscription-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .subscription-card.featured { border-color: var(--text-accent); }
        .subscription-card h5 { font-size: 1.2rem; margin-bottom: 5px;}
        .subscription-card .price { font-size: 2.5rem; font-weight: 700; color: var(--text-accent); margin-bottom: 10px; }
        .subscription-card .price-term { font-size: 0.9rem; color: var(--text-secondary); }
        .subscription-card ul { list-style: none; margin: 25px 0; padding: 0; text-align: left;}
        .subscription-card li { margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .subscription-card li::before { content: '‚úîÔ∏è'; color: var(--bg-accent); }
        .subscription-card .primary-btn { width: 100%; justify-content: center; }

        /* About Section Styles */
        .about-section .profile-picture-setting { margin-bottom: 20px; }

        .streak-week-view {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
        }
        .streak-day-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        .streak-day-item .day-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .streak-day-item .day-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 1.5rem;
            background-color: var(--bg-input);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .streak-day-item.active .day-icon {
            background-color: var(--bg-accent);
            border-color: var(--bg-accent);
            color: var(--text-on-accent);
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .streak-day-item.current .day-icon {
            border-color: var(--text-accent);
        }

        #detail-modal .modal-body { display: flex; flex-direction: column; gap: 15px; }
        .detail-header { text-align: center; }
        .detail-header .task-subject-tag { display: inline-block; margin-bottom: 8px;}
        .detail-header h3 { font-size: 1.5rem; }
        .detail-header p { color: var(--text-secondary); }
        .detail-item {
            background: var(--bg-input);
            padding: 12px;
            border-radius: 8px;
        }
        .detail-item strong {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        /* ==========================================================================
           9. FOCUS VIEW & OTHER MODALS
           ========================================================================== */
        #focus-view {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            gap: 30px;
            text-align: center;
        }
        #focus-view.active {
             display: flex;
        }
        #focus-view-timer {
            position: relative;
            width: 300px;
            height: 300px;
        }
        #focus-view-timer svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        #focus-view-timer .timer-circle-bg { 
            stroke-width: 15;
            fill: none;
            stroke: var(--bg-input);
        }
        #focus-view-timer .timer-circle-progress { 
            stroke-width: 15; 
            fill: none;
            stroke-linecap: round;
            stroke: var(--text-accent);
            transition: stroke-dashoffset 1s linear;
        }
        #focus-view-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-primary);
        }
        #focus-view-session-display { 
            font-size: 1.2rem; 
            color: var(--text-secondary);
        }
        #focus-view .pomodoro-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        #focus-view .pomodoro-controls .pomodoro-control-btn {
            width: 60px; height: 60px;
            background-color: var(--bg-widget);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        #focus-view .pomodoro-controls .pomodoro-control-btn:hover {
            background-color: var(--bg-hover);
            transform: scale(1.1);
        }
        #focus-view .pomodoro-controls .pomodoro-control-btn svg { width: 30px; height: 30px; transform: none; }


        #notepad-modal .modal-content { max-width: 900px; width: 90%; height: 85vh; padding: 0; }
        .notepad-container { flex-grow: 1; display: flex; min-height: 0; }
        .notes-list-panel {
            width: 280px; flex-shrink: 0; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        .notes-list-header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        #notes-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex-grow: 1; }
        .note-list-item {
            padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px;
            transition: background-color 0.2s; position: relative;
        }
        .note-list-item:hover { background-color: var(--bg-hover); }
        .note-list-item.active { background-color: var(--bg-accent); color: var(--text-on-accent); }
        .note-list-item.active .note-list-item-date { color: var(--text-on-accent); opacity: 0.8; }
        .note-list-item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-list-item-date { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }
        #note-editor-panel { flex-grow: 1; display: flex; flex-direction: column; padding: 20px; }
        #active-note-title {
            font-size: 1.5rem; font-weight: 600; border: none; background: transparent;
            color: var(--text-primary); width: 100%; margin-bottom: 10px; padding: 10px 0;
            border-bottom: 1px solid var(--border-color); outline: none;
        }
        #active-note-title:focus {
            border-bottom-color: var(--text-accent);
        }
        #active-note-content {
            flex-grow: 1; width: 100%; border: none; padding: 15px; font-family: 'Inter', sans-serif;
            font-size: 1rem; background-color: var(--bg-input); color: var(--text-primary);
            outline: none; resize: none; border-radius: 8px;
        }
        #delete-note-btn {
             background: none; border: none; color: var(--danger); font-size: 1.2em;
             cursor: pointer; opacity: 0; transition: opacity .2s;
             position: absolute; right: 12px; top: 12px;
        }
        .note-list-item:hover #delete-note-btn { opacity: 1; }

        #note-editor-footer {
            padding: 10px 0 0 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: right;
            user-select: none;
        }

        .add-new-menu-modal .modal-content {
            max-width: 320px;
            padding: 15px;
        }
        .add-new-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .add-new-menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: none;
            background-color: var(--bg-input);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .add-new-menu-item:hover {
            background-color: var(--bg-hover);
            color: var(--text-accent);
        }
        .add-new-menu-item .menu-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        #habit-days-picker {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .habit-day-picker-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-input);
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .habit-day-picker-btn.active {
            background-color: var(--bg-accent);
            color: var(--text-on-accent);
            border-color: var(--bg-accent);
        }

        .ambient-sounds-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .sound-control-item {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background-color: var(--bg-input);
            border-radius: 8px;
        }
        .sound-control-item .sound-name {
            font-weight: 500;
        }
        .sound-control-item .sound-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: var(--bg-hover);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        .sound-control-item .sound-play-btn:hover {
            background-color: var(--border-color);
        }
        .sound-control-item .sound-play-btn.playing {
            background-color: var(--bg-accent);
            color: var(--text-on-accent);
        }
        .sound-control-item input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--text-accent);
        }

        /* ==========================================================================
           10. NOTIFICATIONS (NEW)
           ========================================================================== */
        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .notification {
            background-color: var(--bg-widget);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-dark);
            border: 1px solid var(--border-color);
            border-left-width: 5px;
            border-left-style: solid;
            max-width: 320px;
            font-weight: 500;
            animation: notification-animation 4.5s cubic-bezier(0.1, 0.82, 0.25, 1) forwards;
        }

        .notification.success { border-left-color: var(--success); }
        .notification.danger { border-left-color: var(--danger); }
        .notification.info { border-left-color: var(--info); }
        .notification.warning { border-left-color: var(--warning); }

        @keyframes notification-animation {
            0% {
                opacity: 0;
                transform: translateX(120%);
            }
            10%, 90% { /* Slide in, stay visible */
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(120%);
            }
        }
    </style>
</head>
<body class="">

    <input type="date" id="quick-add-date-picker" style="position: absolute; visibility: hidden; top: -9999px; left: -9999px;">
    <input type="time" id="quick-add-time-picker" style="position: absolute; visibility: hidden; top: -9999px; left: -9999px;">

    <aside class="sidebar">
        <div class="sidebar-header">
            <img id="profile-pic" class="profile-pic" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzZBNzM4MyIgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCI+PHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDNjMS42NiAwIDMgMS4zNCAzIDNzLTEuMzQgMy0zIDMtMy0xLjM0LTMtMyAxLjM0LTMgMy0zem0wIDE0LjJjLTIuNSAwLTQuNzEtMS4yOC02LTEuMjguMDMtMi4zOCAzLjk5LTQuMTIgNi00LjEyIDIgMCA1Ljk3IDEuNzQgNiA0LjEyLTEuMjktMS0zLjUtMS4yLTUtMS4yeiIvPjwvc3ZnPg==" alt="Profile Picture">
            <input type="file" id="pfp-upload" accept="image/*" style="display:none;">
            <h1>Ultimate Planner</h1>
        </div>

        <div class="sidebar-top-controls">
            <div class="nav-section">
                <button class="primary-btn" id="open-add-new-menu-btn">‚ûï Add New</button>
            </div>
        </div>
       
        <div class="main-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="#" class="nav-link active" data-view="dashboard-view"><span class="nav-icon">üè†</span> Dashboard</a>
               
                <div class="nav-item-with-submenu">
                    <a href="#" class="nav-link" data-view="tasks-view"><span class="nav-icon">üìã</span> Tasks</a>
                    <div id="task-filter-nav">
                        <button class="filter-link active" data-category="all"><span class="nav-icon">üìÇ</span> All</button>
                        <button class="filter-link" data-category="Tasks"><span class="nav-icon">‚úîÔ∏è</span> Tasks</button>
                        <button class="filter-link" data-category="Exams"><span class="nav-icon">‚úçÔ∏è</span> Exams</button>
                        <button class="filter-link" data-category="Vacations"><span class="nav-icon">üèñÔ∏è</span> Vacations</button>
                        <button class="filter-link" data-category="Trips"><span class="nav-icon">‚úàÔ∏è</span> Trips</button>
                        <button class="filter-link" data-category="Extras"><span class="nav-icon">‚≠ê</span> Extras</button>
                    </div>
                </div>
                <a href="#" class="nav-link" data-view="subjects-view"><span class="nav-icon">üìö</span> Subjects</a>
                <a href="#" class="nav-link" data-view="calendar-view"><span class="nav-icon">üìÖ</span> Calendar</a>
            </div>
             <div class="nav-section">
                <div class="nav-section-title">Tools</div>
                <a href="#" class="nav-link" id="open-notepad-btn"><span class="nav-icon">üìù</span> Notepad</a>
                <a href="#" class="nav-link" id="open-ambient-sounds-btn"><span class="nav-icon">üé∂</span> Ambient Sounds</a>
                <a href="#" class="nav-link" id="open-horoscope-btn"><span class="nav-icon">üîÆ</span> Horoscope</a>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="#" class="nav-link" data-view="settings-view">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
            <a href="#" class="nav-link theme-toggle-btn">
                <span class="nav-icon" id="theme-icon">üåô</span>
                <span id="theme-text">Dark Mode</span>
            </a>
        </div>
    </aside>

    <div class="app-container">
        <main class="main-content">
            <div id="dashboard-view" class="view active">
                <div class="hero-banner">
                    <h2 id="greeting">Good evening.</h2>
                    <p id="task-summary">You have 0 tasks for today.</p>
                    <div class="up-next-card">
                        <h4>UP NEXT</h4>
                        <div class="up-next-details" id="up-next-container">
                        </div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-main">
                        <div class="widget tasks-overview">
                            <div class="widget-header">
                                <h4>Today's Tasks</h4>
                                <button class="primary-btn" id="open-new-task-modal-btn-dash">+ Task</button>
                            </div>
                            <div id="today-tasks-list"></div>
                            <div id="quick-add-container">
                                <input type="text" id="quick-task-input" placeholder="Add a task and press Enter...">
                                <div id="quick-add-actions">
                                    <button class="quick-add-btn" data-action="quick-subject">Subject</button>
                                    <button class="quick-add-btn active" data-action="quick-due-date" data-date="today">Today</button>
                                    <button class="quick-add-btn" data-action="quick-due-date" data-date="tomorrow">Tomorrow</button>
                                    <button class="quick-add-btn" data-action="quick-custom-date">Date</button>
                                    <button class="quick-add-btn" data-action="quick-time">Time</button>
                                </div>
                                <div id="quick-add-subject-popover">
                                    <ul id="quick-add-subject-list"></ul>
                                </div>
                            </div>
                        </div>
                         <div class="widget tasks-overview"><h4>Upcoming</h4><div id="upcoming-tasks-list"></div></div>
                    </div>
                    <div class="dashboard-side">
                        <div class="side-widget-container">
                             <div class="side-widget" id="streak-widget"><div class="side-widget-value" id="streak-display">üî• 0</div><div class="side-widget-label">Streak</div></div>
                            <div class="side-widget"><div class="side-widget-value" id="weather-display">--¬∞</div><div class="side-widget-label" id="weather-city"></div></div>
                        </div>

                        <div class="widget schedule-widget">
                            <h3>Today's Schedule</h3>
                            <div class="schedule-timeline" id="schedule-timeline-content">
                            </div>
                            <div class="schedule-time-labels">
                                <span>6am</span>
                                <span>10am</span>
                                <span>2pm</span>
                                <span>6pm</span>
                                <span>10pm</span>
                            </div>
                        </div>
                       
                        <div id="pomodoro-widget" class="widget pomodoro-widget">
                            <h3>Pomodoro</h3>
                            <div class="timer-visual">
                                <svg>
                                    <circle class="timer-circle-bg" cx="70" cy="70" r="65"></circle>
                                    <circle id="pomodoro-progress" class="timer-circle-progress" cx="70" cy="70" r="65"></circle>
                                </svg>
                                <div id="pomodoro-display">25:00</div>
                            </div>
                            <div id="pomodoro-session-display"></div>
                            <div class="pomodoro-controls">
                                <button class="pomodoro-control-btn" data-action="settings" aria-label="Pomodoro Settings" title="Settings"></button>
                                <button class="pomodoro-control-btn" data-action="reset" aria-label="Reset Pomodoro" title="Reset"></button>
                                <button class="pomodoro-control-btn" data-action="toggle" aria-label="Start/Pause Pomodoro" title="Start/Pause" style="width: 50px; height: 50px;"></button>
                                <button class="pomodoro-control-btn" data-action="skip" aria-label="Skip Session" title="Skip"></button>
                            </div>
                        </div>
                        <div class="widget habit-tracker-widget">
                             <div class="widget-header">
                                <h3>Habit Tracker</h3>
                                <button class="secondary-btn" id="add-new-habit-btn" style="padding: 5px 10px; font-size: 0.8rem;">+ New Habit</button>
                            </div>
                            <div id="habit-list-container"></div>
                        </div>
                    </div>
                </div>
            </div>
           
            <div id="tasks-view" class="view">
                 <div class="page-header">
                     <h2 id="tasks-view-title">All Tasks</h2>
                      <div class="header-actions">
                         <div class="search-container">
                             <input type="search" id="sidebar-search" placeholder="Search tasks...">
                         </div>
                         <button class="primary-btn" id="open-new-task-modal-btn-2">+ Task</button>
                     </div>
                 </div>
                 <div id="all-tasks-container">
                 </div>
            </div>

            <div id="subjects-view" class="view">
                <div class="page-header">
                    <h2>Subjects</h2>
                    <div class="header-actions">
                        <button class="primary-btn" id="add-new-subject-btn">+ New Subject</button>
                    </div>
                </div>
                <div class="subjects-grid" id="subjects-grid-container">
                </div>
            </div>

            <div id="calendar-view" class="view">
                <div class="widget">
                    <div class="calendar-header">
                        <h3 id="calendar-month-year"></h3>
                        <div class="calendar-nav">
                            <button class="secondary-btn" id="toggle-classes-btn">Hide Classes</button>
                            <button class="secondary-btn" id="cal-prev-btn"><</button>
                            <button class="secondary-btn" id="cal-today-btn">Today</button>
                            <button class="secondary-btn" id="cal-next-btn">></button>
                        </div>
                    </div>
                    <div class="calendar-grid-container" id="calendar-header-days"></div>
                    <div class="calendar-grid-container" id="calendar-body"></div>
                </div>
            </div>

            <div id="settings-view" class="view">
                <div class="page-header">
                    <h2>Settings</h2>
                </div>
                <div class="settings-layout">
                    <nav class="settings-nav">
                        <a href="#" class="settings-nav-link active" data-pane="account"><span class="nav-icon">üë§</span> Account</a>
                        <a href="#" class="settings-nav-link" data-pane="customize"><span class="nav-icon">üé®</span> Customize</a>
                        <a href="#" class="settings-nav-link" data-pane="subscription"><span class="nav-icon">üí≥</span> Subscription</a>
                        <a href="#" class="settings-nav-link" data-pane="about"><span class="nav-icon">‚ÑπÔ∏è</span> About</a>
                    </nav>
                    <div class="settings-content-wrapper">
                        <div id="settings-account-pane" class="settings-content-pane active">
                            <h3>Account</h3>
                            <div class="settings-section">
                                <h4>Profile Picture</h4>
                                <div class="profile-picture-setting">
                                    <div class="profile-picture-placeholder">
                                        <img id="settings-profile-pic" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzZBNzM4MyIgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCI+PHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDNjMS42NiAwIDMgMS4zNCAzIDNzLTEuMzQgMy0zIDMtMy0xLjM0LTMtMyAxLjM0LTMgMy0zem0wIDE0LjJjLTIuNSAwLTQuNzEtMS4yOC02LTEuMjguMDMtMi4zOCAzLjk5LTQuMTIgNi00LjEyIDIgMCA1Ljk3IDEuNzQgNiA0LjEyLTEuMjktMS0zLjUtMS4yLTUtMS4yeiIvPjwvc3ZnPg==" alt="Profile Picture">
                                    </div>
                                    <button class="primary-btn" id="change-picture-btn">Change Picture</button>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>Danger Zone</h4>
                                <p>This action is irreversible. Please proceed with caution.</p>
                                <button class="danger-btn" id="delete-account-btn">Delete Account</button>
                            </div>
                        </div>
                        <div id="settings-customize-pane" class="settings-content-pane">
                            <h3>Customize</h3>
                            <div class="settings-section">
                                <h4>Tag Colors</h4>
                                <p>Customize the colors for your different task categories for better visual organization.</p>
                                <div id="tag-color-customizer-container">
                                </div>
                            </div>
                        </div>
                        <div id="settings-subscription-pane" class="settings-content-pane">
                            <h3>Subscription</h3>
                             <div class="settings-section">
                                <h4>Upgrade to Premium</h4>
                                <p>Unlock the full potential of Ultimate Planner with exclusive features for Premium users.</p>
                                <div class="subscription-grid">
                                    <div class="subscription-card">
                                        <h5>Basic</h5>
                                        <div class="price">Free</div>
                                        <ul>
                                            <li>Unlimited Tasks</li>
                                            <li>Subject Management</li>
                                            <li>Habit Tracker</li>
                                        </ul>
                                        <button class="secondary-btn" disabled>Current Plan</button>
                                    </div>
                                    <div class="subscription-card featured">
                                        <h5>Premium</h5>
                                        <div class="price">$5<span class="price-term">/month</span></div>
                                        <ul>
                                            <li>Everything in Basic</li>
                                            <li>Cloud Sync</li>
                                            <li>Calendar Integration</li>
                                            <li>Additional Themes</li>
                                            <li>Priority Support</li>
                                        </ul>
                                        <button class="primary-btn">Upgrade to Premium</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="settings-about-pane" class="settings-content-pane">
                            <h3>About</h3>
                             <div class="settings-section about-section">
                                 <h4>Ultimate Student Planner</h4>
                                <p>Hello! I'm the creator of this tool. My goal is to provide students with a simple, powerful, all-in-one platform to organize their academic and personal lives. I hope it helps you on your path to success!</p>
                             </div>
                             <div class="settings-section">
                                 <h4>Contact Me</h4>
                                 <p>Have a question, suggestion, or found a bug? I'd love to hear from you. Fill out the form, and I'll get back to you as soon as possible.</p>
                                 <form id="contact-form">
                                     <div class="form-group">
                                         <label for="contact-name">Your Name</label>
                                         <input type="text" id="contact-name" required>
                                     </div>
                                      <div class="form-group">
                                         <label for="contact-email">Your Email</label>
                                         <input type="email" id="contact-email" required>
                                     </div>
                                      <div class="form-group">
                                         <label for="contact-message">Message</label>
                                         <textarea id="contact-message" rows="5" required></textarea>
                                     </div>
                                     <button type="submit" class="primary-btn">Send Message</button>
                                 </form>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
           
            <div id="focus-view" class="view">
                 <div id="focus-view-timer">
                     <svg>
                         <circle class="timer-circle-bg" cx="150" cy="150" r="140"></circle>
                         <circle id="focus-view-progress" class="timer-circle-progress" cx="150" cy="150" r="140"></circle>
                     </svg>
                     <div id="focus-view-display">25:00</div>
                 </div>
                 <div id="focus-view-session-display">Session 1 / 4</div>
                 <div class="pomodoro-controls" id="focus-view-controls">
                 </div>
                 <button class="secondary-btn" id="exit-focus-view-btn">Exit Focus Mode</button>
            </div>
        </main>
    </div>
   
    <div id="calendar-tooltip"></div>

    <div id="add-new-menu-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New</h3>
                <button class="close-modal-btn" data-modal-id="add-new-menu-modal">&times;</button>
            </div>
            <div class="modal-body" style="padding-right: 0; margin-right: 0;">
                <div class="add-new-menu">
                    <button class="add-new-menu-item" data-action="add-task">
                        <span class="menu-icon">üìã</span>
                        <span>Task</span>
                    </button>
                    <button class="add-new-menu-item" data-action="add-subject">
                        <span class="menu-icon">üìö</span>
                        <span>Subject</span>
                    </button>
                     <button class="add-new-menu-item" data-action="add-exam">
                        <span class="menu-icon">‚úçÔ∏è</span>
                        <span>Exam</span>
                    </button>
                     <button class="add-new-menu-item" data-action="add-vacation">
                        <span class="menu-icon">üèñÔ∏è</span>
                        <span>Vacation</span>
                    </button>
                     <button class="add-new-menu-item" data-action="add-extra">
                        <span class="menu-icon">‚≠ê</span>
                        <span>Extra</span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="add-new-item-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Item</h3>
                <button class="close-modal-btn" data-modal-id="add-new-item-modal">&times;</button>
            </div>
            <form id="add-new-item-form" class="modal-body">
                <div class="form-group">
                    <label for="add-new-item-type">What would you like to add?</label>
                    <select id="add-new-item-type">
                        <option value="task" selected>Task</option>
                        <option value="exam">Exam</option>
                        <option value="vacation">Vacation</option>
                    </select>
                </div>

                <div id="add-new-task-form" class="add-new-form active">
                    <div class="form-group">
                        <label for="new-task-title">Title *</label>
                        <input type="text" id="new-task-title" placeholder="Task title" required>
                    </div>
                    <div class="form-group">
                        <label for="new-task-details">Details</label>
                        <textarea id="new-task-details" placeholder="Task description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-task-subject">Subject *</label>
                            <select id="new-task-subject"></select>
                        </div>
                        <div class="form-group">
                            <label for="new-task-type">Type *</label>
                            <select id="new-task-type"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-task-due-date">Due Date *</label>
                        <input type="date" id="new-task-due-date" required>
                    </div>
                </div>

                <div id="add-new-exam-form" class="add-new-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-exam-subject">Subject *</label>
                            <select id="new-exam-subject" required></select>
                        </div>
                        <div class="form-group">
                            <label for="new-exam-mode">Mode</label>
                            <input type="text" id="new-exam-mode" value="In Person">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-exam-module">Module/Exam Name *</label>
                        <input type="text" id="new-exam-module" placeholder="e.g. Midterm Exam 1" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-exam-room">Room</label>
                            <input type="text" id="new-exam-room" placeholder="Room number">
                        </div>
                        <div class="form-group">
                            <label for="new-exam-seat">Seat</label>
                            <input type="text" id="new-exam-seat" placeholder="Seat number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-exam-date">Date *</label>
                            <input type="date" id="new-exam-date" required>
                        </div>
                        <div class="form-group">
                            <label for="new-exam-time">Time *</label>
                            <input type="time" id="new-exam-time" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-exam-duration">Duration (in minutes) *</label>
                        <input type="number" id="new-exam-duration" placeholder="Numbers only" required>
                    </div>
                </div>
               
                <div id="add-new-vacation-form" class="add-new-form">
                    <div class="form-group">
                        <label for="new-vacation-name">Name *</label>
                        <input type="text" id="new-vacation-name" placeholder="Name of the vacation" required>
                    </div>
                    <div class="form-group">
                        <label for="new-vacation-details">Details</label>
                        <textarea id="new-vacation-details" placeholder="Description of the vacation" rows="3"></textarea>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="new-vacation-start-date">Start Date *</label>
                            <input type="date" id="new-vacation-start-date" required>
                        </div>
                        <div class="form-group">
                            <label for="new-vacation-end-date">End Date *</label>
                            <input type="date" id="new-vacation-end-date" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Photo</label>
                        <label class="photo-upload-container" for="new-vacation-photo">
                            <img id="vacation-photo-preview" src="" alt="Preview" style="display:none;"/>
                            <div id="vacation-photo-placeholder">
                                <div class="plus-icon">+</div>
                                <span>Upload photo</span>
                            </div>
                        </label>
                        <input type="file" id="new-vacation-photo" accept="image/*" style="display:none;">
                    </div>
                </div>
            </form>
            <div class="modal-actions">
                <button type="button" class="secondary-btn close-modal-btn" data-modal-id="add-new-item-modal">Cancel</button>
                <button type="submit" form="add-new-item-form" class="primary-btn">Save</button>
            </div>
        </div>
    </div>

    <div id="subject-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="subject-modal-title"></h3><button class="close-modal-btn" data-modal-id="subject-modal">&times;</button></div>
            <div class="modal-body">
                <form id="subject-form">
                    <input type="hidden" id="subject-id">
                    <div class="form-group"><label for="subject-name">Subject Name</label><input type="text" id="subject-name" required></div>
                    <div class="form-group"><label for="subject-teacher">Professor (Optional)</label><input type="text" id="subject-teacher"></div>
                    <div class="form-row">
                        <div class="form-group"><label for="subject-classroom">Room/Classroom (Optional)</label><input type="text" id="subject-classroom"></div>
                        <div class="form-group"><label for="subject-building">Building (Optional)</label><input type="text" id="subject-building"></div>
                    </div>
                    <div class="form-group"><label>Schedule (Optional)</label><div id="schedule-container"></div><button type="button" class="secondary-btn" id="add-schedule-btn">+ Add Schedule</button></div>
                    <div class="form-group"><label>Color</label><div class="color-picker" id="subject-color-picker"></div></div>
                </form>
            </div>
            <div class="modal-actions"><button type="button" class="secondary-btn close-modal-btn" data-modal-id="subject-modal">Cancel</button><button type="submit" form="subject-form" class="primary-btn">Save</button></div>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay">
        <div class="modal-content">
             <div class="modal-header">
                <h3 id="detail-modal-title">Details</h3>
                <button class="close-modal-btn" data-modal-id="detail-modal">&times;</button>
            </div>
            <div class="modal-body" id="detail-modal-body">
            </div>
             <div class="modal-actions">
                <button type="button" class="primary-btn close-modal-btn" data-modal-id="detail-modal">Close</button>
            </div>
        </div>
    </div>

     <div id="task-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="task-modal-title"></h3><button class="close-modal-btn" data-modal-id="task-modal">&times;</button></div>
            <form id="task-form" class="modal-body">
                <input type="hidden" id="task-id">
                <div class="form-group"><label for="task-name">Task Name</label><input type="text" id="task-name" required></div>
                <div class="form-group"><label for="task-due-date">Due Date</label><input type="date" id="task-due-date" required></div>
               
                <div class="form-group">
                    <label for="task-category">Category</label>
                    <select id="task-category" required></select>
                </div>

                <div class="form-group"><label for="task-subject">Subject</label><select id="task-subject" required></select></div>
            </form>
            <div class="modal-actions"><button type="button" class="secondary-btn close-modal-btn" data-modal-id="task-modal">Cancel</button><button type="submit" form="task-form" class="primary-btn">Save</button></div>
        </div>
    </div>
    <div id="day-view-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="day-view-modal-title">Day's Events</h3>
                <button class="close-modal-btn" data-modal-id="day-view-modal">&times;</button>
            </div>
            <div class="modal-body" id="day-view-modal-body">
            </div>
            <div class="modal-actions">
                 <button type="button" class="primary-btn close-modal-btn" data-modal-id="day-view-modal">Close</button>
            </div>
        </div>
    </div>
    <div id="streak-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Your Weekly Streak</h3>
                <button class="close-modal-btn" data-modal-id="streak-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="streak-week-view" id="streak-week-view-container">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="primary-btn close-modal-btn" data-modal-id="streak-modal">Great!</button>
            </div>
        </div>
    </div>
    <div id="notepad-modal" class="modal-overlay">
         <div class="modal-content" style="max-width: 900px; width: 90%; height: 85vh; padding: 0;">
             <div class="modal-header" style="padding: 15px 20px;"><h3>Notepad</h3><button class="close-modal-btn" data-modal-id="notepad-modal">&times;</button></div>
             <div class="notepad-container">
                 <div class="notes-list-panel">
                     <div class="notes-list-header"><button id="new-note-btn" class="primary-btn" style="width: 100%;">+ New Note</button></div>
                     <ul id="notes-list"></ul>
                 </div>
                 <div class="note-editor-panel" id="note-editor-panel">
                 </div>
             </div>
         </div>
    </div>
     <div id="horoscope-modal" class="modal-overlay">
        <div class="modal-content">
             <div class="modal-header"><h3 id="horoscope-modal-title">Your Horoscope</h3><button class="close-modal-btn" data-modal-id="horoscope-modal">&times;</button></div>
            <div class="modal-body" style="text-align: center;">
                 <div id="horoscope-emoji" style="font-size: 4rem; margin-bottom: 15px;"></div>
                <p id="horoscope-text" style="font-size: 1.1rem; line-height: 1.6;"></p>
            </div>
        </div>
    </div>

    <div id="delete-account-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Are you absolutely sure?</h3>
                <button class="close-modal-btn" data-modal-id="delete-account-confirmation-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color:var(--text-secondary); line-height: 1.6;">This action is <strong>irreversible</strong>. All your tasks, subjects, habits, and other data will be permanently deleted from the application.</p>
                <p style="color:var(--text-secondary); line-height: 1.6; margin-top: 15px;">To confirm, please type <strong>DELETE</strong> in the field below.</p>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="delete-confirmation-input">Confirmation</label>
                    <input type="text" id="delete-confirmation-input" placeholder="Type here to confirm...">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn close-modal-btn" data-modal-id="delete-account-confirmation-modal">Cancel</button>
                <button type="button" id="final-delete-btn" class="danger-btn" disabled>I understand the consequences, delete my account</button>
            </div>
        </div>
    </div>

    <div id="pomodoro-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pomodoro Settings</h3>
                <button class="close-modal-btn" data-modal-id="pomodoro-settings-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="pomodoro-focus-time">Focus Time (min)</label>
                    <input type="number" id="pomodoro-focus-time" min="1">
                </div>
                 <div class="form-group">
                    <label for="pomodoro-break-time">Break Time (min)</label>
                    <input type="number" id="pomodoro-break-time" min="1">
                </div>
                 <div class="form-group">
                    <label for="pomodoro-sessions-goal">Session Goal</label>
                    <input type="number" id="pomodoro-sessions-goal" min="1">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="primary-btn close-modal-btn" data-modal-id="pomodoro-settings-modal">Done</button>
            </div>
        </div>
    </div>
   
    <div id="ambient-sounds-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ambient Sounds</h3>
                <button class="close-modal-btn" data-modal-id="ambient-sounds-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ambient-sounds-container">
                    <div class="sound-control-item">
                        <button class="sound-play-btn" data-sound="rain">‚ñ∂Ô∏è</button>
                        <span class="sound-name">Rain üåßÔ∏è</span>
                        <input type="range" class="sound-volume" data-sound="rain" min="0" max="1" step="0.1" value="0.5">
                    </div>
                    <div class="sound-control-item">
                        <button class="sound-play-btn" data-sound="cafe">‚ñ∂Ô∏è</button>
                        <span class="sound-name">Cafe ‚òï</span>
                        <input type="range" class="sound-volume" data-sound="cafe" min="0" max="1" step="0.1" value="0.5">
                    </div>
                    <div class="sound-control-item">
                        <button class="sound-play-btn" data-sound="forest">‚ñ∂Ô∏è</button>
                        <span class="sound-name">Forest üå≤</span>
                        <input type="range" class="sound-volume" data-sound="forest" min="0" max="1" step="0.1" value="0.5">
                    </div>
                </div>
            </div>
             <div class="modal-actions">
                <button type="button" class="primary-btn close-modal-btn" data-modal-id="ambient-sounds-modal">Close</button>
            </div>
        </div>
    </div>

    <div id="habit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="habit-modal-title">New Habit</h3>
                <button class="close-modal-btn" data-modal-id="habit-modal">&times;</button>
            </div>
            <form id="habit-form" class="modal-body">
                <input type="hidden" id="habit-id-input">
                <div class="form-group">
                    <label for="habit-name-input">Habit Name</label>
                    <input type="text" id="habit-name-input" required>
                </div>
                <div class="form-group">
                    <label for="habit-target-input">Times per day</label>
                    <input type="number" id="habit-target-input" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label>Track on these days</label>
                    <div id="habit-days-picker">
                    </div>
                </div>
            </form>
            <div class="modal-actions">
                <button type="button" class="secondary-btn close-modal-btn" data-modal-id="habit-modal">Cancel</button>
                <button type="submit" form="habit-form" class="primary-btn">Save</button>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>
    
    <audio id="alert-sound" src="https://www.soundjay.com/buttons/beep-07.mp3" preload="auto"></audio>
    <audio id="audio-rain" src="https://www.soundjay.com/nature/rain-03.mp3" loop preload="auto"></audio>
    <audio id="audio-cafe" src="https://www.soundjay.com/human/people-talking-inside-a-cafe-01.mp3" loop preload="auto"></audio>
    <audio id="audio-forest" src="https://www.soundjay.com/nature/forest-recreation-area-1.mp3" loop preload="auto"></audio>

    <script>
    (() => {
        const App = {
            icons: {
                play: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>',
                pause: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>',
                restart: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-4.42-8-8-8z"></path></svg>',
                skip: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="m6 18 8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>',
                settings: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>'
            },
            state: {
                subjects: [],
                tasks: [],
                habits: [],
                notes: [],
                activeNoteId: null,
                pomodoro: {
                    isRunning: false,
                    isBreak: false,
                    timeLeft: 25 * 60,
                    intervalId: null,
                    settings: { focus: 25, break: 5 },
                    sessions: {
                        current: 0,
                        goal: 4
                    }
                },
                ambient: {
                    currentSound: null,
                    audioElements: {}
                },
                streak: { 
                    count: 0, 
                    loginHistory: [] 
                },
                theme: 'light',
                currentView: 'dashboard-view',
                calendar: { 
                    date: new Date(),
                    showClasses: true
                },
                profilePic: null,
                taskFilters: {
                    category: 'all',
                    searchTerm: ''
                },
                quickAdd: {
                    dueDate: 'today',
                    subjectId: 'general',
                    subjectName: 'General',
                    time: null
                },
                taskCategories: ['Tasks', 'Exams', 'Vacations', 'Trips', 'Extras'],
                tagColors: {
                    'Exams': '#e74c3c',
                    'Vacations': '#FFBE0B',
                    'Trips': '#8338EC',
                    'Extras': '#1abc9c',
                    'Tasks': '#3498db',
                },
                subjectColorPalette: ['#FF6B6B', '#FF9F43', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', '#EF476F', '#6B4226', '#7209B7', '#3A86FF', '#FB5607', '#8338EC'],
            },

            dataManager: {
                save() {
                    const stateToSave = {
                        subjects: App.state.subjects,
                        tasks: App.state.tasks,
                        habits: App.state.habits,
                        notes: App.state.notes,
                        activeNoteId: App.state.activeNoteId,
                        streak: App.state.streak,
                        theme: App.state.theme,
                        profilePic: App.state.profilePic,
                        tagColors: App.state.tagColors,
                        calendar: { showClasses: App.state.calendar.showClasses },
                        pomodoro: {
                            settings: App.state.pomodoro.settings,
                            sessionsGoal: App.state.pomodoro.sessions.goal
                        }
                    };
                    localStorage.setItem('ultimatePlannerState', JSON.stringify(stateToSave));
                },
                load() {
                    const loadedState = JSON.parse(localStorage.getItem('ultimatePlannerState'));
                    if (loadedState) {
                        if (loadedState.habits && loadedState.habits.length > 0 && loadedState.habits[0].hasOwnProperty('completion')) {
                            loadedState.habits = loadedState.habits.map(oldHabit => ({
                                id: oldHabit.id,
                                name: oldHabit.name,
                                target: 1,
                                days: Array(7).fill(true),
                                progress: oldHabit.completion.map(c => c ? 1 : 0)
                            }));
                        }

                        if (loadedState.pomodoro) {
                            Object.assign(App.state.pomodoro.settings, loadedState.pomodoro.settings);
                            App.state.pomodoro.sessions.goal = loadedState.pomodoro.sessionsGoal || 4;
                            delete loadedState.pomodoro;
                        }
                        if (loadedState.calendar) {
                            App.state.calendar.showClasses = loadedState.calendar.showClasses ?? true;
                            delete loadedState.calendar;
                        }
                        if (loadedState.streak && !Array.isArray(loadedState.streak.loginHistory)) {
                           loadedState.streak = { count: loadedState.streak.count || 0, loginHistory: [] };
                        }
                       
                        if (loadedState.tagColors) {
                            App.state.tagColors = { ...App.state.tagColors, ...loadedState.tagColors };
                        }

                        Object.assign(App.state, loadedState);
                        App.state.calendar.date = new Date();
                    }
                },
                addHabit(habitData) {
                    const newHabit = {
                        id: `h_${Date.now()}`,
                        name: habitData.name,
                        target: habitData.target,
                        days: habitData.days,
                        progress: [0, 0, 0, 0, 0, 0, 0]
                    };
                    App.state.habits.push(newHabit);
                    this.save();
                    App.ui.showNotification('New habit added!', 'success');
                },
                updateHabit(id, updatedData) {
                    const habit = App.state.habits.find(h => h.id === id);
                    if (habit) {
                        Object.assign(habit, updatedData);
                        this.save();
                        App.ui.showNotification('Habit updated!', 'success');
                    }
                },
                deleteHabit(id) {
                    App.state.habits = App.state.habits.filter(h => h.id !== id);
                    this.save();
                    App.ui.showNotification('Habit deleted.', 'danger');
                },
                getHabit: (id) => App.state.habits.find(h => h.id === id),
                cycleHabitProgress(id, dayIndex) {
                    const habit = this.getHabit(id);
                    if (habit && habit.days[dayIndex]) {
                        habit.progress[dayIndex]++;
                        if (habit.progress[dayIndex] > habit.target) {
                            habit.progress[dayIndex] = 0;
                        }
                        this.save();
                    }
                },
                addSubject(subject) { 
                    App.state.subjects.push({ id: `s_${Date.now()}`, ...subject }); 
                    this.save();
                    App.ui.showNotification('New subject created!', 'success');
                },
                updateSubject(subject) {
                    const index = App.state.subjects.findIndex(s => s.id === subject.id);
                    if (index > -1) {
                        App.state.subjects[index] = subject;
                        App.ui.showNotification('Subject updated!', 'success');
                    }
                    this.save();
                },
                deleteSubject(id) {
                    App.state.subjects = App.state.subjects.filter(s => s.id !== id);
                    App.state.tasks.forEach(t => { if(t.subjectId === id) t.subjectId = 'general'; });
                    this.save();
                    App.ui.showNotification('Subject deleted.', 'danger');
                },
                getSubject: (id) => App.state.subjects.find(s => s.id === id) || { name: 'General', color: '#6A7383' },
                getSubjectByName(name) { return App.state.subjects.find(s => s.name.toLowerCase() === name.toLowerCase()); },
                addTask(task) { 
                    App.state.tasks.push({ id: `t_${Date.now()}`, completed: false, ...task }); 
                    this.save();
                    App.ui.showNotification(`New ${task.category.slice(0, -1)} added!`, 'success');
                },
                updateTask(task) {
                    const index = App.state.tasks.findIndex(t => t.id === task.id);
                    if (index > -1) {
                        App.state.tasks[index] = task;
                        App.ui.showNotification('Task updated!', 'success');
                    }
                    this.save();
                },
                deleteTask(id) { 
                    App.state.tasks = App.state.tasks.filter(t => t.id !== id); 
                    this.save();
                    App.ui.showNotification('Task deleted.', 'danger');
                },
                toggleTask(id) {
                    const task = App.state.tasks.find(t => t.id === id);
                    if (task) {
                        task.completed = !task.completed;
                        if(task.completed) {
                            App.ui.showNotification('Task completed! üéâ', 'success');
                        }
                    }
                    this.save();
                },
                getTask: (id) => App.state.tasks.find(t => t.id === id),
                getTasksForDate(date) {
                    const dateStr = date.toISOString().split('T')[0];
                    return App.state.tasks.filter(t => t.dueDate === dateStr);
                },
                getClassesForDate(date) {
                    const dayOfWeek = (date.getDay() + 6) % 7;
                    return App.state.subjects.filter(subject => 
                        subject.schedule?.some(slot => parseInt(slot.day, 10) === dayOfWeek)
                    );
                },
                getUpcomingTasks() {
                    const today = new Date(); today.setHours(0,0,0,0);
                    return App.state.tasks.filter(t => new Date(t.dueDate) > today && !t.completed)
                        .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).slice(0, 5);
                },
                getUpNextItem() {
                    const now = new Date();
                    const todayIndex = (now.getDay() + 6) % 7;
                    const upcomingToday = [];
                    App.state.subjects.forEach(subject => {
                        subject.schedule?.forEach(slot => {
                            if(parseInt(slot.day, 10) === todayIndex) {
                                const [startH, startM] = slot.startTime.split(':').map(Number);
                                const eventStart = new Date(); 
                                eventStart.setHours(startH, startM, 0, 0);
                                if (eventStart > now) {
                                    upcomingToday.push({ 
                                        name: subject.name,
                                        timeInfo: `${slot.startTime} - ${slot.endTime}`, 
                                        color: subject.color, 
                                        type: 'class', 
                                        eventStart 
                                    });
                                }
                            }
                        });
                    });
                    return upcomingToday.sort((a,b) => a.eventStart - b.eventStart)[0];
                },
                addNote() {
                    const newNote = { id: `n_${Date.now()}`, title: 'New Note', content: '', lastModified: Date.now() };
                    App.state.notes.unshift(newNote);
                    App.state.activeNoteId = newNote.id;
                    this.save();
                    App.ui.showNotification('New note created!', 'success');
                    return newNote;
                },
                updateNote(id, { title, content }) {
                    const note = App.state.notes.find(n => n.id === id);
                    if(note) { 
                        if (title !== undefined) note.title = title;
                        if (content !== undefined) note.content = content;
                        note.lastModified = Date.now(); 
                    }
                    this.save();
                },
                deleteNote(id){
                    App.state.notes = App.state.notes.filter(n => n.id !== id);
                    if(App.state.activeNoteId === id) App.state.activeNoteId = null;
                    this.save();
                    App.ui.showNotification('Note deleted.', 'danger');
                },
                updateStreak() {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const history = App.state.streak.loginHistory || [];
                   
                    if (history.includes(todayStr)) {
                        return;
                    }

                    history.push(todayStr);

                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    App.state.streak.loginHistory = history.filter(d => new Date(d) >= thirtyDaysAgo);

                    let currentStreak = 0;
                    let checkDate = new Date();
                    while (true) {
                        const checkDateStr = checkDate.toISOString().split('T')[0];
                        if (App.state.streak.loginHistory.includes(checkDateStr)) {
                            currentStreak++;
                            checkDate.setDate(checkDate.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                    App.state.streak.count = currentStreak;
                    this.save();
                }
            },
           
            ui: {
                init() {
                    this.applyTheme();
                    this.renderProfilePic();
                    this.renderAll();
                    this.setupEventListeners();
                    this.startClocks();
                    this.ambientSounds.init();
                    App.ui.pomodoro.reset(true, false);
                },
                renderAll() { this.renderView(); this.renderDashboard(); this.renderTasksView(); this.renderSubjectsView(); this.renderCalendar(); this.renderFocusView(); this.renderSettingsView();},
                applyTheme() { document.body.classList.toggle('dark-mode', App.state.theme === 'dark'); document.getElementById('theme-icon').textContent = App.state.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'; document.getElementById('theme-text').textContent = App.state.theme === 'dark' ? 'Light Mode' : 'Dark Mode'; },
                startClocks() { const update = () => { this.renderGreeting(); }; update(); setInterval(update, 60000); },
                renderGreeting() { const hour = new Date().getHours(); const greetingEl = document.getElementById('greeting'); if (hour < 12) greetingEl.textContent = 'Good morning.'; else if (hour < 19) greetingEl.textContent = 'Good afternoon.'; else greetingEl.textContent = 'Good evening.'; },
                showNotification(message, type = 'info', duration = 4500) {
                    const container = document.getElementById('notification-container');
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.textContent = message;
                    container.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, duration);
                },
                renderView() { 
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); 
                    document.getElementById(App.state.currentView)?.classList.add('active'); 
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
                    document.querySelector(`.nav-link[data-view="${App.state.currentView}"]`)?.classList.add('active'); 

                    const showTaskControls = App.state.currentView === 'tasks-view';
                    const taskFilterNav = document.getElementById('task-filter-nav');
                   
                    if (showTaskControls) {
                        taskFilterNav.classList.add('open');
                    } else {
                        taskFilterNav.classList.remove('open');
                    }
                },
                renderDashboard() { const todayTaskCount = App.dataManager.getTasksForDate(new Date()).filter(t=>!t.completed).length; document.getElementById('task-summary').textContent = `You have ${todayTaskCount} task${todayTaskCount !== 1 ? 's' : ''} left for today.`; const upNextItem = App.dataManager.getUpNextItem(); const upNextContainer = document.getElementById('up-next-container'); if (upNextItem) { upNextContainer.innerHTML = `<div class="up-next-timeline" style="background-color: ${upNextItem.color || 'var(--text-on-accent)'};"></div><div class="up-next-info"><h5>${upNextItem.name}</h5><p>${upNextItem.timeInfo}</p></div>`; } else { upNextContainer.innerHTML = `<div class="up-next-info"><h5>You're free for now.</h5><p>Good job!</p></div>`; } document.getElementById('streak-display').textContent = `üî• ${App.state.streak.count}`; document.getElementById('weather-display').textContent = '28¬∞'; document.getElementById('weather-city').textContent = 'Kissimmee, FL'; const todayList = document.getElementById('today-tasks-list'); const upcomingList = document.getElementById('upcoming-tasks-list'); todayList.innerHTML = ''; upcomingList.innerHTML = ''; App.dataManager.getTasksForDate(new Date()).forEach(t => todayList.appendChild(this.createTaskElement(t, 'list-item'))); App.dataManager.getUpcomingTasks().forEach(t => upcomingList.appendChild(this.createTaskElement(t, 'list-item'))); if (todayList.innerHTML === '') todayList.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:10px;">All done for today! ‚ú®</p>'; if (upcomingList.innerHTML === '') upcomingList.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:10px;">No upcoming tasks.</p>'; this.renderPomodoro(); this.renderHabitTracker(); this.renderTodaySchedule(); },
               
                renderTasksView() {
                    const container = document.getElementById('all-tasks-container');
                    if (!container) return;
                    container.innerHTML = '';
                    const { category, searchTerm } = App.state.taskFilters;
                   
                    document.getElementById('tasks-view-title').textContent = category === 'all' ? 'All Tasks' : category;

                    let filteredTasks = App.state.tasks;

                    if (category !== 'all') {
                        filteredTasks = filteredTasks.filter(t => t.category === category);
                    }
                    if (searchTerm) {
                        const lowerCaseSearchTerm = searchTerm.toLowerCase();
                        filteredTasks = filteredTasks.filter(t => t.name.toLowerCase().includes(lowerCaseSearchTerm));
                    }

                    const todayStr = new Date().toISOString().split('T')[0];
                    const today = new Date(todayStr);

                    const sections = {
                        overdue: [], today: [], upcoming: [], completed: []
                    };

                    filteredTasks.forEach(task => {
                        if (task.completed) {
                            sections.completed.push(task);
                        } else {
                            const dueDate = new Date(task.dueDate + 'T00:00:00');
                            if (dueDate < today) {
                                sections.overdue.push(task);
                            } else if (task.dueDate === todayStr) {
                                sections.today.push(task);
                            } else {
                                sections.upcoming.push(task);
                            }
                        }
                    });
                   
                    const renderSection = (title, tasks, isCompletedSection = false) => {
                        if (tasks.length === 0 && !isCompletedSection) return '';
                       
                        const sectionEl = document.createElement('div');
                        sectionEl.className = 'tasks-section';
                        const tasksHTML = tasks
                            .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
                            .map(t => this.createTaskElement(t, 'card').outerHTML)
                            .join('');

                        sectionEl.innerHTML = `<h3 class="tasks-section-header">${title}</h3><div class="tasks-container">${tasks.length > 0 ? tasksHTML : '<p style="color:var(--text-secondary); padding:10px 0;">No completed tasks.</p>'}</div>`;
                        return sectionEl.outerHTML;
                    };
                   
                    let finalHTML = '';
                    finalHTML += renderSection('Overdue', sections.overdue);
                    finalHTML += renderSection('Today', sections.today);
                    finalHTML += renderSection('Upcoming', sections.upcoming);
                    finalHTML += renderSection('Completed', sections.completed, true);
                   
                    container.innerHTML = finalHTML;
                   
                    if (container.innerHTML.trim() === '') {
                        container.innerHTML = `<p style="color:var(--text-secondary); text-align:center; padding:20px;">No tasks found with the current filters.</p>`;
                    }
                },

                renderSubjectsView() {
                    const container = document.getElementById('subjects-grid-container');
                    this.renderSubjectsGrid(container);
                },

                renderSubjectsGrid(containerEl) {
                    if (!containerEl) return;
                    containerEl.innerHTML = '';
                    if (App.state.subjects.length === 0) {
                        containerEl.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:20px;">Create your first subject to get organized.</p>';
                        return;
                    }
                    App.state.subjects.forEach(s => containerEl.appendChild(this.createSubjectElement(s)));
                },
                renderCalendar() {
                    const calBody = document.getElementById('calendar-body');
                    const calHeader = document.getElementById('calendar-header-days');
                    const toggleBtn = document.getElementById('toggle-classes-btn');
                   
                    toggleBtn.textContent = App.state.calendar.showClasses ? 'Hide Classes' : 'Show Classes';
                    calBody.innerHTML = '';
                    calHeader.innerHTML = '';
                    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => calHeader.innerHTML += `<div class="calendar-day-name">${day}</div>`);
                    const date = App.state.calendar.date;
                    document.getElementById('calendar-month-year').textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    const month = date.getMonth();
                    const year = date.getFullYear();
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const MAX_ITEMS_VISIBLE = 3;

                    for (let i = 0; i < firstDayOfMonth; i++) {
                        calBody.innerHTML += `<div class="calendar-day not-current-month"></div>`;
                    }
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayCell = document.createElement('div');
                        dayCell.className = 'calendar-day';
                        const thisDate = new Date(year, month, i);
                        const thisDateStr = thisDate.toISOString().split('T')[0];

                        if (thisDate.toDateString() === new Date().toDateString()) {
                            dayCell.classList.add('today');
                        }

                        dayCell.innerHTML = `<div class="day-number" data-date="${thisDateStr}">${i}</div><div class="calendar-tasks"></div>`;
                        const tasksContainer = dayCell.querySelector('.calendar-tasks');
                       
                        let itemsForDay = App.dataManager.getTasksForDate(thisDate);

                        if (App.state.calendar.showClasses) {
                            const classesForDay = App.dataManager.getClassesForDate(thisDate);
                            itemsForDay = itemsForDay.concat(classesForDay.map(c => ({...c, type: 'class'})));
                        }

                        itemsForDay.slice(0, MAX_ITEMS_VISIBLE).forEach(item => {
                            const itemEl = document.createElement('div');
                            if (item.type === 'class') {
                                itemEl.className = 'calendar-class-item';
                                itemEl.dataset.subjectId = item.id;
                                itemEl.style.backgroundColor = item.color;
                                itemEl.innerHTML = `<span class="task-icon">üéì</span> <span>${item.name}</span>`;
                            } else {
                                itemEl.className = 'calendar-task-item';
                                itemEl.dataset.taskId = item.id;
                                const subject = App.dataManager.getSubject(item.subjectId);
                                const tagColor = App.state.tagColors[item.category] || subject.color;
                                itemEl.style.backgroundColor = tagColor;
                                let icon = '';
                                if(item.category === 'Exams') icon = '‚úçÔ∏è';
                                else if(item.category === 'Tasks') icon = '‚úîÔ∏è';
                                else if(item.category === 'Trips') icon = '‚úàÔ∏è';
                                else if(item.category === 'Vacations') icon = 'üèñÔ∏è';
                                else if(item.category === 'Extras') icon = '‚≠ê';
                                itemEl.innerHTML = `<span class="task-icon">${icon}</span> <span>${item.name}</span>`;
                            }
                            tasksContainer.appendChild(itemEl);
                        });

                        if (itemsForDay.length > MAX_ITEMS_VISIBLE) {
                            const moreEl = document.createElement('div');
                            moreEl.className = 'calendar-more-indicator';
                            moreEl.dataset.date = thisDateStr;
                            moreEl.textContent = `+${itemsForDay.length - MAX_ITEMS_VISIBLE} more...`;
                            tasksContainer.appendChild(moreEl);
                        }

                        calBody.appendChild(dayCell);
                    }
                },
                renderTodaySchedule() { const timeline = document.getElementById('schedule-timeline-content'); if (!timeline) return; timeline.innerHTML = ''; const todayIndex = (new Date().getDay() + 6) % 7; const timelineStartHour = 6; const timelineEndHour = 22; const totalTimelineMinutes = (timelineEndHour - timelineStartHour) * 60; const timeToMinutes = (timeStr) => { if(!timeStr) return 0; const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; }; App.state.subjects.forEach(subject => { subject.schedule?.forEach(slot => { if (parseInt(slot.day, 10) === todayIndex) { const startMinutes = timeToMinutes(slot.startTime); const endMinutes = timeToMinutes(slot.endTime); const left = ((startMinutes - (timelineStartHour * 60)) / totalTimelineMinutes) * 100; const width = ((endMinutes - startMinutes) / totalTimelineMinutes) * 100; if (width > 0 && left >= 0 && left < 100) { const eventEl = document.createElement('div'); eventEl.className = 'schedule-event'; eventEl.dataset.subjectId = subject.id; eventEl.style.left = `${left}%`; eventEl.style.width = `${width}%`; eventEl.style.backgroundColor = subject.color; eventEl.title = `${subject.name}\n${slot.startTime} - ${slot.endTime}`; timeline.appendChild(eventEl); } } }); }); },
               
                updatePomodoroProgress(progressCircle, display, totalDuration, timeLeft) {
                    const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                    const seconds = String(timeLeft % 60).padStart(2, '0');
                    if (display) display.textContent = `${minutes}:${seconds}`;

                    if (progressCircle) {
                        const radius = progressCircle.r.baseVal.value;
                        const circumference = 2 * Math.PI * radius;
                        const progress = totalDuration > 0 ? timeLeft / totalDuration : 0;
                        const offset = circumference * (1 - progress);
                        progressCircle.style.strokeDasharray = circumference;
                        progressCircle.style.strokeDashoffset = offset;
                    }
                },

                renderPomodoro() {
                    const { timeLeft, isRunning, isBreak, settings, sessions } = App.state.pomodoro;
                    const widget = document.getElementById('pomodoro-widget');
                    if (!widget) return;
                   
                    const widgetProgress = widget.querySelector('#pomodoro-progress');
                    const display = widget.querySelector('#pomodoro-display');
                    const sessionDisplay = widget.querySelector('#pomodoro-session-display');
                    const toggleBtn = widget.querySelector('[data-action="toggle"]');
                    const resetBtn = widget.querySelector('[data-action="reset"]');
                    const skipBtn = widget.querySelector('[data-action="skip"]');
                    const settingsBtn = widget.querySelector('[data-action="settings"]');
                    const totalDuration = (isBreak ? settings.break : settings.focus) * 60;
                   
                    this.updatePomodoroProgress(widgetProgress, display, totalDuration, timeLeft);
                    sessionDisplay.textContent = `Session ${sessions.current || 1} / ${sessions.goal}`;

                    toggleBtn.innerHTML = isRunning ? App.icons.pause : App.icons.play;
                    resetBtn.innerHTML = App.icons.restart;
                    skipBtn.innerHTML = App.icons.skip;
                    settingsBtn.innerHTML = App.icons.settings;
                },

                renderFocusView() {
                     if (App.state.currentView !== 'focus-view') return;

                    const { timeLeft, isRunning, isBreak, settings, sessions } = App.state.pomodoro;
                    const totalDuration = (isBreak ? settings.break : settings.focus) * 60;
                    const focusControls = document.getElementById('focus-view-controls');
                   
                    this.updatePomodoroProgress(document.getElementById('focus-view-progress'), document.getElementById('focus-view-display'), totalDuration, timeLeft);
                    document.getElementById('focus-view-session-display').textContent = `Session ${sessions.current || 1} of ${sessions.goal} - ${isBreak ? 'Break' : 'Focus'}`;

                    focusControls.innerHTML = `
                          <button class="pomodoro-control-btn" data-action="reset" aria-label="Reset Pomodoro">${App.icons.restart}</button>
                          <button class="pomodoro-control-btn" data-action="toggle" aria-label="Start/Pause Pomodoro" style="width: 70px; height: 70px;">
                              ${isRunning ? App.icons.pause : App.icons.play}
                          </button>
                          <button class="pomodoro-control-btn" data-action="skip" aria-label="Skip Session">${App.icons.skip}</button>
                        `;
                },
               
                renderSettingsView() {
                    const container = document.getElementById('tag-color-customizer-container');
                    if (!container) return;
                    container.innerHTML = '';
                    for (const tagName in App.state.tagColors) {
                        const color = App.state.tagColors[tagName];
                        const item = document.createElement('div');
                        item.className = 'tag-customize-item';
                        item.innerHTML = `
                            <span class="tag-name">${tagName}</span>
                            <div class="color-input-wrapper">
                                <input type="color" value="${color}" data-tag-name="${tagName}">
                            </div>
                        `;
                        container.appendChild(item);
                    }
                },

                renderHabitTracker() {
                    const container = document.getElementById('habit-list-container');
                    container.innerHTML = '';
                    if (App.state.habits.length === 0) {
                        container.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:10px;">Add your first habit to get started.</p>';
                        return;
                    }

                    App.state.habits.forEach(habit => {
                        const row = document.createElement('div');
                        row.className = 'habit-row';
                       
                        const weekHTML = habit.days.map((isActive, i) => {
                            const dayInitial = ['M','T','W','T','F','S','S'][i];
                            let content = dayInitial;
                            let classes = 'day-label';

                            if (!isActive) {
                                classes += ' inactive';
                            } else {
                                const progress = habit.progress[i];
                                const target = habit.target;
                                if (progress >= target) {
                                    classes += ' completed';
                                    content = '‚úî';
                                } else if (progress > 0) {
                                    classes += ' partial';
                                    content = progress;
                                }
                            }
                            return `<div class="${classes}" data-habit-id="${habit.id}" data-day="${i}">${content}</div>`;
                        }).join('');
                       
                        row.innerHTML = `
                            <div class="habit-row-actions">
                                <button class="habit-action-btn" data-action="edit-habit" data-habit-id="${habit.id}" title="Edit Habit">‚úèÔ∏è</button>
                                <button class="habit-action-btn" data-action="delete-habit" data-habit-id="${habit.id}" title="Delete Habit">üóëÔ∏è</button>
                            </div>
                            <span class="habit-name" data-habit-id="${habit.id}">${habit.name}</span>
                            <div class="habit-week-tracker">${weekHTML}</div>
                        `;
                        container.appendChild(row);
                    });
                },
                createTaskElement(task, type) {
                    const el = document.createElement('div');
                    const subject = App.dataManager.getSubject(task.subjectId);
                    const tagColor = App.state.tagColors[task.category] || subject.color;

                    if (type === 'list-item') {
                        el.className = 'task-list-item';
                        el.dataset.taskId = task.id;
                        let tagHTML = '';
                        if (App.state.tagColors[task.category]) {
                            tagHTML = `<span class="task-subject-tag" style="background-color: ${tagColor};">${task.category}</span>`;
                        } else {
                            tagHTML = `<span class="task-subject-tag" style="background-color: ${subject.color};">${subject.name}</span>`;
                        }
                        el.innerHTML = `
                            <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
                            <div class="task-details">
                                <span class="task-name ${task.completed ? 'completed' : ''}">${task.name}</span>
                            </div>
                            ${tagHTML}`;
                    } else { // type === 'card'
                        el.className = 'task-card';
                        el.id = `task-card-${task.id}`;
                        el.dataset.taskId = task.id;
                       
                        let tagsContainerHTML = `<span class="task-subject-tag" style="background-color: ${tagColor}; color: white;">${task.category}</span>`;
                       
                        if (!App.state.tagColors[task.category] && task.subjectId !== 'general') {
                             tagsContainerHTML += `<span class="task-subject-tag" style="background-color: ${subject.color};">${subject.name}</span>`;
                        }

                        el.innerHTML = `
                            <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
                            <div class="task-details">
                                <span class="task-name ${task.completed ? 'completed' : ''}">${task.name}</span>
                                <div class="task-due-date">Due: ${new Date(task.dueDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
                            </div>
                            <div class="task-tags-container">${tagsContainerHTML}</div>
                            <div class="task-actions">
                                <button class="delete-btn edit-btn" data-task-id="${task.id}" data-action="edit">‚úèÔ∏è</button>
                                <button class="delete-btn" data-task-id="${task.id}" data-action="delete">üóëÔ∏è</button>
                            </div>
                        `;
                    }
                    return el;
                },
                createSubjectElement(subject) { const card = document.createElement('div'); card.className = 'subject-card'; card.id = `subject-card-${subject.id}`; card.dataset.subjectId = subject.id; card.style.backgroundColor = subject.color; card.innerHTML = `<h4>${subject.name}</h4><p>${subject.teacher || 'No professor'}</p><div class="subject-card-actions"><button class="subject-action-btn" data-subject-id="${subject.id}" data-action="edit">‚úèÔ∏è</button><button class="subject-action-btn" data-subject-id="${subject.id}" data-action="delete">üóëÔ∏è</button></div>`; return card; },
                openModal(id) { document.getElementById(id).classList.add('active'); },
                closeModal(id) { document.getElementById(id).classList.remove('active'); },
                prepareSubjectModal(id = null) {
                    const form = document.getElementById('subject-form');
                    form.reset();
                    document.getElementById('subject-modal-title').textContent = id ? 'Edit Subject' : 'New Subject';
                   
                    const picker = document.getElementById('subject-color-picker');
                    picker.innerHTML = App.state.subjectColorPalette.map(c => `<div class="color-option" style="background-color: ${c}" data-color-value="${c}"></div>`).join('');
                   
                    const scheduleContainer = document.getElementById('schedule-container');
                    scheduleContainer.innerHTML = '';
                   
                    document.getElementById('subject-id').value = id || '';
                   
                    if (id) {
                        const s = App.dataManager.getSubject(id);
                        if (!s) { console.error("Subject not found for editing:", id); return; }

                        document.getElementById('subject-name').value = s.name;
                        document.getElementById('subject-teacher').value = s.teacher || '';
                        document.getElementById('subject-classroom').value = s.classroom || '';
                        document.getElementById('subject-building').value = s.building || '';
                       
                        const colorOption = picker.querySelector(`[data-color-value="${s.color}"]`);
                        if (colorOption) {
                            picker.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                            colorOption.classList.add('selected');
                        } else {
                             picker.querySelector('.color-option')?.classList.add('selected');
                        }
                       
                        s.schedule?.forEach(slot => this.addScheduleRow(slot.day, slot.startTime, slot.endTime));
                    } else {
                        picker.querySelector('.color-option')?.classList.add('selected');
                    }
                    this.openModal('subject-modal');
                },
                prepareTaskModal(id = null) {
                    const form = document.getElementById('task-form');
                    form.reset();
                    document.getElementById('task-id').value = id || '';
                    document.getElementById('task-modal-title').textContent = id ? 'Edit Task' : 'New Task';
                   
                    const subjectSelect = document.getElementById('task-subject');
                    subjectSelect.innerHTML = '<option value="general" selected>General</option>' + App.state.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

                    const categorySelect = document.getElementById('task-category');
                    categorySelect.innerHTML = App.state.taskCategories.map(c => `<option value="${c}">${c}</option>`).join('');

                    if(id) {
                        const t = App.dataManager.getTask(id);
                        document.getElementById('task-name').value = t.name;
                        document.getElementById('task-due-date').value = t.dueDate;
                        subjectSelect.value = t.subjectId;
                        categorySelect.value = t.category;
                    } else {
                        document.getElementById('task-due-date').valueAsDate = new Date();
                    }
                    this.openModal('task-modal');
                },
                prepareDetailModal(id, type) {
                    const modalTitle = document.getElementById('detail-modal-title');
                    const modalBody = document.getElementById('detail-modal-body');
                    modalBody.innerHTML = '';
                    let detailsHTML = '';

                    const createDetailItem = (label, value) => {
                        if (!value) return '';
                        return `<div class="detail-item"><strong>${label}</strong> ${value}</div>`;
                    };

                    if (type === 'task') {
                        const task = App.dataManager.getTask(id);
                        if (!task) return;
                       
                        const subject = App.dataManager.getSubject(task.subjectId);
                        const tagColor = App.state.tagColors[task.category] || subject.color;
                       
                        const headerTagHTML = `<span class="task-subject-tag" style="background-color: ${tagColor}; color: white;">${task.category}</span>`;
                       
                        modalTitle.textContent = "Task Details";
                       
                        detailsHTML = `<div class="detail-header">
                            ${headerTagHTML}
                            <h3>${task.name}</h3>
                            <p>Due: ${new Date(task.dueDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                        </div>`;
                       
                        if (task.subjectId !== 'general' && !App.state.tagColors[task.category]) {
                            detailsHTML += createDetailItem('SUBJECT', subject.name);
                        }
                       
                        if (task.details) {
                            if (task.category === 'Exams') {
                                detailsHTML += createDetailItem('TIME', task.details.time);
                                detailsHTML += createDetailItem('ROOM', task.details.room);
                                detailsHTML += createDetailItem('SEAT', task.details.seat);
                                detailsHTML += createDetailItem('DURATION', task.details.duration ? `${task.details.duration} min` : '');
                                detailsHTML += createDetailItem('MODE', task.details.mode);
                            } else {
                                detailsHTML += createDetailItem('DETAILS', task.details.description);
                            }
                        }
                    } else if (type === 'subject') {
                        const subject = App.dataManager.getSubject(id);
                        if (!subject) return;
                        modalTitle.textContent = "Subject Details";

                        detailsHTML = `<div class="detail-header">
                            <span class="task-subject-tag" style="background-color: ${subject.color}; color: white;">Subject</span>
                            <h3>${subject.name}</h3>
                            <p>${subject.teacher || 'No professor assigned'}</p>
                        </div>`;
                       
                        detailsHTML += createDetailItem('BUILDING', subject.building);
                        detailsHTML += createDetailItem('ROOM / CLASSROOM', subject.classroom);

                        if (subject.schedule && subject.schedule.length > 0) {
                            detailsHTML += `<div class="detail-item"><strong>WEEKLY SCHEDULE</strong>`;
                            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                            subject.schedule.forEach(slot => {
                                detailsHTML += `<p style="margin-top:5px;">${dayNames[slot.day]}: ${slot.startTime} - ${slot.endTime}</p>`;
                            });
                            detailsHTML += `</div>`;
                        } else {
                            detailsHTML += createDetailItem('SCHEDULE', 'No schedule defined.');
                        }
                    }

                    modalBody.innerHTML = detailsHTML;
                    this.openModal('detail-modal');
                },
               
                prepareAddNewModal(preselectType = 'task', preselectCategory = null) {
                    const form = document.getElementById('add-new-item-form');
                    form.reset();
                   
                    const typeSelect = document.getElementById('add-new-item-type');
                    typeSelect.value = preselectType;


                    const subjectSelects = form.querySelectorAll('select[id*="-subject"]');
                    const subjectOptions = '<option value="general" selected>General</option>' + App.state.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    subjectSelects.forEach(select => select.innerHTML = subjectOptions);
                   
                    const taskTypeSelect = document.getElementById('new-task-type');
                    taskTypeSelect.innerHTML = App.state.taskCategories.map(c => `<option value="${c}">${c}</option>`).join('');
                   
                    if (preselectCategory) {
                        taskTypeSelect.value = preselectCategory;
                    } else {
                         taskTypeSelect.value = 'Tasks';
                    }

                    form.querySelectorAll('input[type="date"]').forEach(input => {
                        if (!input.value) input.valueAsDate = new Date();
                    });
                   
                     form.querySelectorAll('input[type="time"]').forEach(input => {
                        if (!input.value) input.value = '09:00';
                    });
                   
                    const preview = document.getElementById('vacation-photo-preview');
                    preview.src = "";
                    preview.style.display = 'none';
                    document.getElementById('vacation-photo-placeholder').style.display = 'flex';

                    this.switchAddNewForm(typeSelect.value);
                    this.openModal('add-new-item-modal');
                },
               
                switchAddNewForm(type) {
                    document.querySelectorAll('.add-new-form').forEach(form => form.classList.remove('active'));
                    const activeForm = document.getElementById(`add-new-${type}-form`);
                    if (activeForm) {
                        activeForm.classList.add('active');
                        document.querySelectorAll('#add-new-item-form .add-new-form:not(.active) [required]').forEach(el => el.required = false);
                        activeForm.querySelectorAll('[data-required="true"]').forEach(el => el.required = true);
                    }
                },

                preparePomodoroSettingsModal() {
                    document.getElementById('pomodoro-focus-time').value = App.state.pomodoro.settings.focus;
                    document.getElementById('pomodoro-break-time').value = App.state.pomodoro.settings.break;
                    document.getElementById('pomodoro-sessions-goal').value = App.state.pomodoro.sessions.goal;
                    this.openModal('pomodoro-settings-modal');
                },
                prepareNotepad() { this.renderNoteList(); this.renderNoteEditor(); this.openModal('notepad-modal'); },
                addScheduleRow(day = '0', start = '09:00', end = '10:00') { const container = document.getElementById('schedule-container'); const row = document.createElement('div'); row.className = 'schedule-entry'; row.innerHTML = `<select class="schedule-day">${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map((d,i) => `<option value="${i}" ${i == day ? 'selected' : ''}>${d}</option>`).join('')}</select><input type="time" class="schedule-start" value="${start}"><span>-</span><input type="time" class="schedule-end" value="${end}"><button type="button" class="delete-btn" data-action="delete-schedule-row">üóëÔ∏è</button>`; container.appendChild(row); },
                renderNoteList(){ const listEl = document.getElementById('notes-list'); listEl.innerHTML = ''; App.state.notes.sort((a,b) => b.lastModified - a.lastModified) .forEach(note => { const li = document.createElement('li'); li.className = `note-list-item ${note.id === App.state.activeNoteId ? 'active' : ''}`; li.dataset.id = note.id; li.innerHTML = `<div class="note-list-item-title">${note.title}</div><div class="note-list-item-date">${new Date(note.lastModified).toLocaleString('en-US')}</div><button id="delete-note-btn" data-action="delete-note" data-id="${note.id}">üóëÔ∏è</button>`; listEl.appendChild(li); }); },
                renderNoteEditor(){ 
                    const editorPanel = document.getElementById('note-editor-panel');
                    const note = App.state.notes.find(n => n.id === App.state.activeNoteId);
                    if (note) {
                        editorPanel.innerHTML = `
                            <input type="text" id="active-note-title" placeholder="Note title..." value="${note.title}">
                            <textarea id="active-note-content" placeholder="Start writing...">${note.content}</textarea>
                            <div id="note-editor-footer">
                                <span id="word-count">0 words</span> &nbsp;|&nbsp; 
                                <span id="char-count">0 characters</span>
                            </div>
                        `;
                        this.updateNoteCounters();
                    } else {
                        editorPanel.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding: 20px;">Select a note or create a new one.</p>';
                    }
                },

                updateNoteCounters() {
                    const content = document.getElementById('active-note-content')?.value || '';
                    const wordCountEl = document.getElementById('word-count');
                    const charCountEl = document.getElementById('char-count');

                    if(wordCountEl && charCountEl) {
                        const charCount = content.length;
                        const words = content.trim().split(/\s+/).filter(Boolean);
                        const wordCount = words.length > 0 && words[0] !== '' ? words.length : 0;

                        wordCountEl.textContent = `${wordCount} word${wordCount !== 1 ? 's' : ''}`;
                        charCountEl.textContent = `${charCount} character${charCount !== 1 ? 's' : ''}`;
                    }
                },
               
                prepareHabitModal(id = null) {
                    const isNew = id === null;
                    document.getElementById('habit-modal-title').textContent = isNew ? 'New Habit' : 'Edit Habit';
                    document.getElementById('habit-id-input').value = id || '';
                   
                    const habit = isNew ? { name: '', target: 1, days: Array(7).fill(true) } : App.dataManager.getHabit(id);

                    document.getElementById('habit-name-input').value = habit.name;
                    document.getElementById('habit-target-input').value = habit.target;

                    const dayPicker = document.getElementById('habit-days-picker');
                    dayPicker.innerHTML = '';
                    ['M', 'T', 'W', 'T', 'F', 'S', 'S'].forEach((day, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'habit-day-picker-btn';
                        btn.textContent = day;
                        btn.dataset.dayIndex = index;
                        if (habit.days[index]) {
                            btn.classList.add('active');
                        }
                        dayPicker.appendChild(btn);
                    });

                    this.openModal('habit-modal');
                },

                renderProfilePic() {
                    const picElements = [document.getElementById('profile-pic'), document.getElementById('settings-profile-pic')];
                    picElements.forEach(pic => {
                        if (pic && App.state.profilePic) {
                           pic.src = App.state.profilePic;
                        }
                    });
                },
                navigateToTask(taskId) {
                    document.getElementById('calendar-tooltip').style.display = 'none';
                    App.state.currentView = 'tasks-view';
                    this.renderAll();
                   
                    setTimeout(() => {
                        const taskCard = document.getElementById(`task-card-${taskId}`);
                        if (taskCard) {
                            taskCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            taskCard.classList.add('highlight');
                            setTimeout(() => taskCard.classList.remove('highlight'), 2500);
                        }
                    }, 100);
                },
                navigateToSubject(subjectId) {
                    document.getElementById('calendar-tooltip').style.display = 'none';
                    App.state.currentView = 'subjects-view';
                    this.renderAll();
                   
                    setTimeout(() => {
                        const subjectCard = document.getElementById(`subject-card-${subjectId}`);
                        if (subjectCard) {
                            subjectCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            subjectCard.classList.add('highlight');
                            setTimeout(() => subjectCard.classList.remove('highlight'), 2500);
                        }
                    }, 100);
                },
                showDayViewModal(dateStr) {
                    const date = new Date(dateStr + 'T00:00:00');
                    const tasks = App.dataManager.getTasksForDate(date);
                   
                    const modalTitle = document.getElementById('day-view-modal-title');
                    const modalBody = document.getElementById('day-view-modal-body');
                   
                    modalTitle.textContent = `Events for ${date.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' })}`;
                   
                    if(tasks.length > 0) {
                        modalBody.innerHTML = tasks.map(task => this.createTaskElement(task, 'list-item').outerHTML).join('');
                    } else {
                        modalBody.innerHTML = '<p>No events for this day.</p>';
                    }
                    this.openModal('day-view-modal');
                },
                prepareStreakModal() {
                    const container = document.getElementById('streak-week-view-container');
                    container.innerHTML = '';
                    const history = App.state.streak.loginHistory || [];
                    const today = new Date();
                    const dayOfWeek = (today.getDay() + 6) % 7; // Monday = 0, Sunday = 6
                   
                    const monday = new Date(today);
                    monday.setDate(today.getDate() - dayOfWeek);

                    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                    for (let i = 0; i < 7; i++) {
                        const date = new Date(monday);
                        date.setDate(monday.getDate() + i);
                        const dateStr = date.toISOString().split('T')[0];
                       
                        const item = document.createElement('div');
                        item.className = 'streak-day-item';
                       
                        if (history.includes(dateStr)) {
                            item.classList.add('active');
                        }
                        if (date.toDateString() === today.toDateString()) {
                            item.classList.add('current');
                        }
                       
                        item.innerHTML = `
                            <div class="day-icon">${history.includes(dateStr) ? 'üî•' : '‚ûñ'}</div>
                            <div class="day-name">${dayNames[i]}</div>
                        `;
                        container.appendChild(item);
                    }
                    this.openModal('streak-modal');
                },

                setupEventListeners() {
                    const popover = document.getElementById('quick-add-subject-popover');

                    document.body.addEventListener('click', e => {
                        if (!popover.contains(e.target) && !e.target.closest('[data-action="quick-subject"]')) {
                            popover.style.display = 'none';
                        }
                       
                        const navLink = e.target.closest('.nav-link');
                        if (navLink) {
                            e.preventDefault();
                            if (navLink.dataset.view) {
                                App.state.currentView = navLink.dataset.view;
                                this.renderAll();
                            } else if (navLink.classList.contains('theme-toggle-btn')) {
                                App.state.theme = App.state.theme === 'light' ? 'dark' : 'light';
                                App.dataManager.save();
                                this.applyTheme();
                                this.showNotification(`Switched to ${App.state.theme} mode`, 'info');
                            } else if (navLink.id === 'open-notepad-btn') {
                                this.prepareNotepad();
                            } else if (navLink.id === 'open-horoscope-btn') {
                                this.showHoroscope();
                            } else if (navLink.id === 'open-ambient-sounds-btn') {
                                this.openModal('ambient-sounds-modal');
                            }
                        }
                       
                        if (e.target.closest('.close-modal-btn')) this.closeModal(e.target.closest('.modal-overlay').id);
                        if (e.target.matches('.modal-overlay')) this.closeModal(e.target.id);
                       
                        if (e.target.closest('#add-new-subject-btn')) this.prepareSubjectModal();
                        if (e.target.closest('#open-new-task-modal-btn-dash') || e.target.closest('#open-new-task-modal-btn-2')) this.prepareAddNewModal('task', 'Tasks');
                       
                        if (e.target.closest('#open-add-new-menu-btn')) {
                            this.openModal('add-new-menu-modal');
                        }
                       
                        const pomodoroControl = e.target.closest('.pomodoro-control-btn');
                        if(pomodoroControl) {
                            e.stopPropagation();
                            const action = pomodoroControl.dataset.action;
                            if (action === 'toggle') this.pomodoro.toggle();
                            else if (action === 'reset') this.pomodoro.reset();
                            else if (action === 'skip') this.pomodoro.finish();
                            else if (action === 'settings') this.preparePomodoroSettingsModal();
                        }

                        if (e.target.closest('#change-picture-btn')) document.getElementById('pfp-upload').click();
                        if (e.target.closest('#streak-widget')) this.prepareStreakModal();
                       
                        const pomodoroWidget = e.target.closest('#pomodoro-widget');
                        if (pomodoroWidget && !e.target.closest('.pomodoro-control-btn')) { 
                            App.state.currentView = 'focus-view'; 
                            this.renderAll(); 
                        }
                       
                        if (e.target.closest('#exit-focus-view-btn')) { App.state.currentView = 'dashboard-view'; this.renderAll(); }

                        if (e.target.closest('.schedule-event')) { this.navigateToSubject(e.target.closest('.schedule-event').dataset.subjectId); }

                        const subjectActionBtn = e.target.closest('.subject-action-btn');
                        if (subjectActionBtn) {
                            const id = subjectActionBtn.dataset.subjectId;
                            if (subjectActionBtn.dataset.action === 'edit') {
                                this.prepareSubjectModal(id);
                            } else if (subjectActionBtn.dataset.action === 'delete') {
                                if (confirm('Are you sure you want to delete this subject? Associated tasks will be moved to "General".')) {
                                    App.dataManager.deleteSubject(id);
                                    this.renderSubjectsView();
                                }
                            }
                        }

                        if(e.target.closest('#add-schedule-btn')) this.addScheduleRow();
                        if(e.target.dataset.action === 'delete-schedule-row') e.target.closest('.schedule-entry').remove();

                        if (e.target.matches('.task-checkbox')) { App.dataManager.toggleTask(e.target.dataset.id); this.renderAll(); }
                       
                        const taskItem = e.target.closest('.task-list-item, .task-card');
                        if (taskItem) {
                            if (!e.target.closest('.task-checkbox, .task-actions, .delete-btn, .edit-btn')) {
                                this.prepareDetailModal(taskItem.dataset.taskId, 'task');
                            }
                        }

                        const subjectCard = e.target.closest('.subject-card');
                        if (subjectCard && !e.target.closest('.subject-action-btn')) {
                            this.prepareDetailModal(subjectCard.dataset.subjectId, 'subject');
                        }

                        const taskActionBtn = e.target.closest('.delete-btn[data-task-id]'); if(taskActionBtn) { const id = taskActionBtn.dataset.taskId; if (taskActionBtn.dataset.action === 'edit') this.prepareTaskModal(id); if (taskActionBtn.dataset.action === 'delete') if (confirm('Delete this task?')) { App.dataManager.deleteTask(id); this.renderAll(); } }
                       
                        if(e.target.closest('#new-note-btn')) { const newNote = App.dataManager.addNote(); this.renderNoteList(); this.renderNoteEditor(); setTimeout(() => document.getElementById('active-note-title')?.focus(), 0); }
                        const noteItem = e.target.closest('.note-list-item'); if(noteItem && !e.target.closest('#delete-note-btn')) { App.state.activeNoteId = noteItem.dataset.id; this.renderNoteList(); this.renderNoteEditor(); }
                        if(e.target.closest('[data-action="delete-note"]')) { App.dataManager.deleteNote(e.target.dataset.id); this.renderNoteList(); this.renderNoteEditor(); }
                       
                        const filterLink = e.target.closest('.filter-link');
                        if (filterLink) {
                            document.querySelectorAll('#task-filter-nav .filter-link').forEach(link => link.classList.remove('active'));
                            filterLink.classList.add('active');
                            App.state.taskFilters.category = filterLink.dataset.category;
                            this.renderTasksView();
                        }
                       
                        if (e.target.closest('#add-new-habit-btn')) {
                            this.prepareHabitModal();
                        }
                        const settingsNavLink = e.target.closest('.settings-nav-link');
                        if(settingsNavLink) {
                            const pane = settingsNavLink.dataset.pane;
                            document.querySelectorAll('.settings-nav-link').forEach(link => link.classList.remove('active'));
                            settingsNavLink.classList.add('active');
                            document.querySelectorAll('.settings-content-pane').forEach(p => p.classList.remove('active'));
                            document.getElementById(`settings-${pane}-pane`).classList.add('active');
                        }
                        if (e.target.closest('#delete-account-btn')) {
                            this.openModal('delete-account-confirmation-modal');
                        }
                        if (e.target.closest('#final-delete-btn')) {
                            this.showNotification('Account deleted successfully.', 'danger');
                            setTimeout(() => {
                                localStorage.clear();
                                window.location.reload();
                            }, 1000);
                        }

                    });
                   
                    const habitContainer = document.querySelector('.habit-tracker-widget');
                    habitContainer.addEventListener('click', e => {
                        const dayLabel = e.target.closest('.day-label:not(.inactive)');
                        const deleteBtn = e.target.closest('[data-action="delete-habit"]');
                        const editBtn = e.target.closest('[data-action="edit-habit"]');
                        const nameSpan = e.target.closest('.habit-name');

                        if (dayLabel) {
                            App.dataManager.cycleHabitProgress(dayLabel.dataset.habitId, dayLabel.dataset.day);
                            this.renderHabitTracker();
                        } else if (deleteBtn) {
                            if (confirm('Are you sure you want to delete this habit?')) {
                                App.dataManager.deleteHabit(deleteBtn.dataset.habitId);
                                this.renderHabitTracker();
                            }
                        } else if (editBtn) {
                            this.prepareHabitModal(editBtn.dataset.habitId);
                        } else if (nameSpan) {
                            const habitId = nameSpan.dataset.habitId;
                            const currentName = nameSpan.textContent;
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'habit-name-input';
                            input.value = currentName;
                           
                            const saveChange = () => {
                                const newName = input.value.trim();
                                if (newName && newName !== currentName) {
                                    App.dataManager.updateHabit(habitId, { name: newName });
                                } else {
                                    this.renderHabitTracker();
                                }
                            };

                            input.addEventListener('blur', saveChange);
                            input.addEventListener('keypress', e => {
                                if (e.key === 'Enter') input.blur();
                            });

                            nameSpan.replaceWith(input);
                            input.focus();
                        }
                    });

                    document.getElementById('habit-days-picker').addEventListener('click', e => {
                        if (e.target.matches('.habit-day-picker-btn')) {
                            e.target.classList.toggle('active');
                        }
                    });

                    document.getElementById('habit-form').addEventListener('submit', e => {
                        e.preventDefault();
                        const id = document.getElementById('habit-id-input').value;
                        const name = document.getElementById('habit-name-input').value;
                        const target = parseInt(document.getElementById('habit-target-input').value, 10);
                        const days = Array.from(document.querySelectorAll('#habit-days-picker .habit-day-picker-btn')).map(btn => btn.classList.contains('active'));
                       
                        const habitData = { name, target, days };

                        if (id) {
                            App.dataManager.updateHabit(id, habitData);
                        } else {
                            App.dataManager.addHabit(habitData);
                        }
                        this.closeModal('habit-modal');
                        this.renderHabitTracker();
                    });
                   
                    const calendarBody = document.getElementById('calendar-body');
                    const tooltip = document.getElementById('calendar-tooltip');
                    const scheduleTimeline = document.getElementById('schedule-timeline-content');

                    const setupTooltip = (container) => {
                         container.addEventListener('mouseover', e => {
                            const item = e.target.closest('.calendar-task-item, .calendar-class-item, .schedule-event');
                            if (!item) return;
                           
                            let content = '';
                            if(item.classList.contains('calendar-task-item')) {
                                const task = App.dataManager.getTask(item.dataset.taskId);
                                if(!task) return;
                                const subject = App.dataManager.getSubject(task.subjectId);
                                content = `<h5>${task.name}</h5><p><strong>Subject:</strong> ${subject.name}</p>`;
                            } else if (item.classList.contains('calendar-class-item')) {
                                const subject = App.dataManager.getSubject(item.dataset.subjectId);
                                if(!subject) return;
                                content = `<h5>${subject.name}</h5><p><strong>Class</strong></p>`;
                            } else if (item.classList.contains('schedule-event')) {
                                content = `<h5>${item.title.replace('\n', '<br>')}</h5>`;
                            }

                            tooltip.innerHTML = content;
                            tooltip.style.display = 'block';
                        });

                         container.addEventListener('mousemove', e => {
                            tooltip.style.left = e.pageX + 15 + 'px';
                            tooltip.style.top = e.pageY + 15 + 'px';
                        });
                       
                         container.addEventListener('mouseout', e => {
                            if (e.target.closest('.calendar-task-item, .calendar-class-item, .schedule-event')) {
                                tooltip.style.display = 'none';
                            }
                        });
                    };

                    setupTooltip(calendarBody);
                    setupTooltip(scheduleTimeline);
                   
                    calendarBody.addEventListener('click', e => {
                        const taskItem = e.target.closest('.calendar-task-item');
                        if (taskItem) {
                            e.preventDefault();
                            this.navigateToTask(taskItem.dataset.taskId);
                        }
                        const classItem = e.target.closest('.calendar-class-item');
                        if (classItem) {
                            e.preventDefault();
                            this.prepareDetailModal(classItem.dataset.subjectId, 'subject');
                        }

                        const dayTrigger = e.target.closest('.day-number, .calendar-more-indicator');
                        if (dayTrigger) {
                            e.preventDefault();
                            this.showDayViewModal(dayTrigger.dataset.date);
                        }
                    });


                    document.getElementById('add-new-item-form').addEventListener('submit', e => {
                        e.preventDefault();
                        const type = document.getElementById('add-new-item-type').value;
                        let taskData = { subjectId: 'general', details: {} };

                        if (type === 'task') {
                            taskData = {
                                name: document.getElementById('new-task-title').value,
                                dueDate: document.getElementById('new-task-due-date').value,
                                category: document.getElementById('new-task-type').value,
                                subjectId: document.getElementById('new-task-subject').value,
                                details: { description: document.getElementById('new-task-details').value }
                            };
                        } else if (type === 'exam') {
                             taskData = {
                                name: document.getElementById('new-exam-module').value,
                                dueDate: document.getElementById('new-exam-date').value,
                                category: 'Exams',
                                subjectId: document.getElementById('new-exam-subject').value,
                                details: { mode: document.getElementById('new-exam-mode').value, room: document.getElementById('new-exam-room').value, seat: document.getElementById('new-exam-seat').value, time: document.getElementById('new-exam-time').value, duration: document.getElementById('new-exam-duration').value }
                            };
                        } else if (type === 'vacation') {
                             taskData = {
                                name: document.getElementById('new-vacation-name').value,
                                dueDate: document.getElementById('new-vacation-start-date').value,
                                category: 'Vacations',
                                subjectId: 'general',
                                details: { description: document.getElementById('new-vacation-details').value, endDate: document.getElementById('new-vacation-end-date').value, photo: document.getElementById('vacation-photo-preview').src }
                            };
                        }

                        App.dataManager.addTask(taskData);
                        this.closeModal('add-new-item-modal');
                        this.renderAll();
                    });

                    document.getElementById('add-new-item-type').addEventListener('change', e => { this.switchAddNewForm(e.target.value); });
                   
                    document.getElementById('new-vacation-photo').addEventListener('change', e => {
                          const file = e.target.files[0];
                          if (file) {
                              const reader = new FileReader();
                              reader.onload = (event) => {
                                  const preview = document.getElementById('vacation-photo-preview');
                                  preview.src = event.target.result;
                                  preview.style.display = 'block';
                                  document.getElementById('vacation-photo-placeholder').style.display = 'none';
                              };
                              reader.readAsDataURL(file);
                          }
                    });

                    document.getElementById('pomodoro-settings-modal').addEventListener('input', e => {
                        const { pomodoro } = App.state;
                        let changed = false;
                        if (e.target.id === 'pomodoro-focus-time') { pomodoro.settings.focus = parseInt(e.target.value) || 25; changed = true; }
                        if (e.target.id === 'pomodoro-break-time') { pomodoro.settings.break = parseInt(e.target.value) || 5; changed = true; }
                        if (e.target.id === 'pomodoro-sessions-goal') { pomodoro.sessions.goal = parseInt(e.target.value) || 4; changed = true; }
                        if (changed) { 
                            if (!pomodoro.isRunning) { this.pomodoro.reset(true, false); } else { this.renderPomodoro(); } 
                            this.showNotification('Pomodoro settings saved!', 'success');
                        }
                        App.dataManager.save();
                    });

                    document.getElementById('subject-form').addEventListener('submit', e => {
                        e.preventDefault();
                        const schedule = Array.from(document.querySelectorAll('#schedule-container .schedule-entry')).map(row => ({ day: row.querySelector('.schedule-day').value, startTime: row.querySelector('.schedule-start').value, endTime: row.querySelector('.schedule-end').value }));
                        const subjectData = { 
                            id: document.getElementById('subject-id').value, 
                            name: document.getElementById('subject-name').value, 
                            teacher: document.getElementById('subject-teacher').value, 
                            classroom: document.getElementById('subject-classroom').value,
                            building: document.getElementById('subject-building').value,
                            color: document.querySelector('#subject-color-picker .selected')?.dataset.colorValue || App.state.subjectColorPalette[0], 
                            schedule 
                        };
                        if (subjectData.id) {
                            App.dataManager.updateSubject(subjectData);
                        } else {
                            App.dataManager.addSubject(subjectData);
                        }
                        this.closeModal('subject-modal');
                        this.renderAll();
                    });
                   
                    document.getElementById('task-form').addEventListener('submit', e => { e.preventDefault(); const taskData = { id: document.getElementById('task-id').value, name: document.getElementById('task-name').value, dueDate: document.getElementById('task-due-date').value, subjectId: document.getElementById('task-subject').value, category: document.getElementById('task-category').value, }; const existingTask = App.dataManager.getTask(taskData.id); if (existingTask) { taskData.completed = existingTask.completed; App.dataManager.updateTask(taskData); } else { App.dataManager.addTask(taskData); } this.closeModal('task-modal'); this.renderAll(); });
                   
                    document.getElementById('subject-color-picker').addEventListener('click', e => { if (e.target.classList.contains('color-option')) { document.querySelectorAll('#subject-color-picker .color-option').forEach(el => el.classList.remove('selected')); e.target.classList.add('selected'); } });
                   
                    document.getElementById('quick-task-input').addEventListener('keypress', e => {
                        if (e.key === 'Enter') {
                            let taskName = e.target.value.trim();
                            if (!taskName) return;
                           
                            if (App.state.quickAdd.time) {
                                const time = App.state.quickAdd.time;
                                const [h, m] = time.split(':');
                                const hours = parseInt(h, 10);
                                const ampm = hours >= 12 ? 'PM' : 'AM';
                                const formattedHours = hours % 12 || 12;
                                const formattedTime = `${formattedHours}:${m} ${ampm}`;
                                taskName += ` @ ${formattedTime}`;
                            }

                            let dueDateStr;
                            if (App.state.quickAdd.dueDate === 'today') {
                                dueDateStr = new Date().toISOString().split('T')[0];
                            } else if (App.state.quickAdd.dueDate === 'tomorrow') {
                                const tomorrow = new Date();
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                dueDateStr = tomorrow.toISOString().split('T')[0];
                            } else {
                                dueDateStr = App.state.quickAdd.dueDate;
                            }

                            App.dataManager.addTask({ name: taskName, dueDate: dueDateStr, subjectId: App.state.quickAdd.subjectId, category: 'Tasks' });
                           
                            e.target.value = '';
                            App.state.quickAdd = { dueDate: 'today', subjectId: 'general', subjectName: 'General', time: null };
                           
                            this.renderAll();
                            document.querySelector('.quick-add-btn[data-action="quick-subject"]').textContent = 'Subject';
                            document.querySelector('.quick-add-btn[data-action="quick-custom-date"]').textContent = 'Date';
                             document.querySelector('.quick-add-btn[data-action="quick-time"]').textContent = 'Time';
                            document.querySelectorAll('#quick-add-actions .quick-add-btn').forEach(btn => btn.classList.remove('active'));
                            document.querySelector('.quick-add-btn[data-date="today"]').classList.add('active');
                        }
                    });

                    document.getElementById('quick-add-actions').addEventListener('click', e => {
                        const target = e.target.closest('.quick-add-btn');
                        if (!target) return;

                        const action = target.dataset.action;
                        if (action === 'quick-due-date') {
                            App.state.quickAdd.dueDate = target.dataset.date;
                            document.querySelectorAll('#quick-add-actions .quick-add-btn').forEach(btn => btn.classList.remove('active'));
                            target.classList.add('active');
                            document.querySelector('.quick-add-btn[data-action="quick-custom-date"]').textContent = 'Date';
                        } else if (action === 'quick-subject') {
                            const popover = document.getElementById('quick-add-subject-popover');
                            const subjectList = document.getElementById('quick-add-subject-list');
                            subjectList.innerHTML = '';

                            [{id: 'general', name: 'General', color: '#6A7383'}, ...App.state.subjects].forEach(subject => {
                                const li = document.createElement('li');
                                li.dataset.subjectId = subject.id;
                                li.dataset.subjectName = subject.name;
                                li.innerHTML = `<span class="subject-color-dot" style="background-color:${subject.color};"></span> ${subject.name}`;
                                subjectList.appendChild(li);
                            });

                            popover.style.display = popover.style.display === 'block' ? 'none' : 'block';
                        } else if (action === 'quick-custom-date') {
                            document.getElementById('quick-add-date-picker').showPicker();
                        } else if (action === 'quick-time') {
                            document.getElementById('quick-add-time-picker').showPicker();
                        }
                    });

                    document.getElementById('quick-add-subject-popover').addEventListener('click', e => {
                        const target = e.target.closest('li');
                        if (!target) return;

                        App.state.quickAdd.subjectId = target.dataset.subjectId;
                        App.state.quickAdd.subjectName = target.dataset.subjectName;

                        const subjectButton = document.querySelector('.quick-add-btn[data-action="quick-subject"]');
                        subjectButton.textContent = App.state.quickAdd.subjectName;

                        document.getElementById('quick-add-subject-popover').style.display = 'none';
                    });
                   
                    document.getElementById('quick-add-date-picker').addEventListener('change', e => {
                        App.state.quickAdd.dueDate = e.target.value;
                        document.querySelectorAll('#quick-add-actions .quick-add-btn').forEach(btn => btn.classList.remove('active'));
                        const dateBtn = document.querySelector('.quick-add-btn[data-action="quick-custom-date"]');
                        dateBtn.classList.add('active');
                        dateBtn.textContent = new Date(e.target.value + 'T00:00:00').toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit'});
                    });

                    document.getElementById('quick-add-time-picker').addEventListener('change', e => {
                        App.state.quickAdd.time = e.target.value;
                        const timeBtn = document.querySelector('.quick-add-btn[data-action="quick-time"]');
                        const [h, m] = e.target.value.split(':');
                        const hours = parseInt(h, 10);
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        const formattedHours = hours % 12 || 12;
                        timeBtn.textContent = `${formattedHours}:${m} ${ampm}`;
                        timeBtn.classList.add('active');
                    });

                    document.getElementById('note-editor-panel').addEventListener('input', e => {
                        if(e.target.id === 'active-note-content') {
                             const id = App.state.activeNoteId;
                            if (id) {
                                App.dataManager.updateNote(id, { content: e.target.value });
                                this.updateNoteCounters();
                                clearTimeout(this.noteRenderTimeout);
                                this.noteRenderTimeout = setTimeout(() => this.renderNoteList(), 500);
                            }
                        }
                    });
                     document.getElementById('note-editor-panel').addEventListener('blur', e => {
                        if(e.target.id === 'active-note-title') {
                             const id = App.state.activeNoteId;
                            if (id) {
                                App.dataManager.updateNote(id, { title: e.target.value });
                                this.renderNoteList();
                                this.showNotification('Note saved!', 'success');
                            }
                        }
                    }, true);


                    document.getElementById('cal-prev-btn').addEventListener('click', () => {App.state.calendar.date.setMonth(App.state.calendar.date.getMonth() - 1); this.renderCalendar()});
                    document.getElementById('cal-today-btn').addEventListener('click', () => {App.state.calendar.date = new Date(); this.renderCalendar()});
                    document.getElementById('cal-next-btn').addEventListener('click', () => {App.state.calendar.date.setMonth(App.state.calendar.date.getMonth() + 1); this.renderCalendar()});
                    document.getElementById('toggle-classes-btn').addEventListener('click', () => {App.state.calendar.showClasses = !App.state.calendar.showClasses; App.dataManager.save(); this.renderCalendar();});
                   
                    document.getElementById('pfp-upload').addEventListener('change', e => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            App.state.profilePic = event.target.result;
                            this.renderProfilePic();
                            App.dataManager.save();
                            this.showNotification('Profile picture updated!', 'success');
                        };
                        reader.readAsDataURL(file);
                    });

                    document.getElementById('sidebar-search').addEventListener('input', e => {
                        App.state.taskFilters.searchTerm = e.target.value;
                        this.renderTasksView();
                    });

                    document.getElementById('add-new-menu-modal').addEventListener('click', e => {
                        const item = e.target.closest('.add-new-menu-item');
                        if (!item) return;

                        const action = item.dataset.action;
                        this.closeModal('add-new-menu-modal');

                        switch (action) {
                            case 'add-task':
                                this.prepareAddNewModal('task', 'Tasks');
                                break;
                            case 'add-subject':
                                this.prepareSubjectModal();
                                break;
                            case 'add-exam':
                                this.prepareAddNewModal('exam');
                                break;
                            case 'add-vacation':
                                this.prepareAddNewModal('vacation');
                                break;
                            case 'add-extra':
                                this.prepareAddNewModal('task', 'Extras');
                                break;
                        }
                    });

                    document.getElementById('contact-form').addEventListener('submit', e => {
                        e.preventDefault();
                        this.showNotification('Thank you for your message!', 'success');
                        e.target.reset();
                    });

                    document.getElementById('delete-confirmation-input').addEventListener('input', e => {
                        const finalDeleteBtn = document.getElementById('final-delete-btn');
                        finalDeleteBtn.disabled = e.target.value !== 'DELETE';
                    });
                   
                    document.getElementById('tag-color-customizer-container').addEventListener('input', e => {
                        if (e.target.matches('input[type="color"]')) {
                            const tagName = e.target.dataset.tagName;
                            const newColor = e.target.value;
                            App.state.tagColors[tagName] = newColor;
                            App.dataManager.save();
                            this.renderAll();
                            this.showNotification('Tag color saved!', 'success');
                        }
                    });

                },
                pomodoro: {
                    toggle() {
                        App.state.pomodoro.isRunning = !App.state.pomodoro.isRunning;
                        if (App.state.pomodoro.isRunning) {
                            if (App.state.pomodoro.timeLeft === App.state.pomodoro.settings.focus * 60 && !App.state.pomodoro.isBreak) {
                                App.state.pomodoro.sessions.current++;
                                App.ui.showNotification(`Starting session ${App.state.pomodoro.sessions.current}!`, 'info');
                            }
                            App.state.pomodoro.intervalId = setInterval(() => this.tick(), 1000);
                        } else {
                            clearInterval(App.state.pomodoro.intervalId);
                        }
                        App.ui.renderPomodoro();
                        App.ui.renderFocusView();
                    },
                    tick() {
                        App.state.pomodoro.timeLeft--;
                        if (App.state.pomodoro.timeLeft < 0) {
                            this.finish();
                        } else {
                           App.ui.renderPomodoro();
                           App.ui.renderFocusView();
                        }
                    },
                    finish() {
                        const { pomodoro } = App.state;
                        clearInterval(pomodoro.intervalId);
                        pomodoro.isRunning = false;
                        document.getElementById('alert-sound').play();
                        
                        const message = pomodoro.isBreak ? 'Break is over. Time to focus!' : 'Session complete! Time for a break.';
                        App.ui.showNotification(message, 'info');

                        if (!pomodoro.isBreak) {
                            if (pomodoro.sessions.current >= pomodoro.sessions.goal) {
                                App.ui.showNotification("Congratulations! You've completed your session goal.", "success");
                                if(App.state.currentView === 'focus-view') {
                                    App.state.currentView = 'dashboard-view';
                                }
                                this.reset();
                                App.ui.renderAll();
                                return;
                            }
                        }
                       
                        pomodoro.isBreak = !pomodoro.isBreak;
                        this.reset(false, false);
                        App.ui.renderPomodoro();
                        App.ui.renderFocusView();
                    },
                    reset(manual = true, stopTimer = true){
                        const { pomodoro } = App.state;
                        if (stopTimer) {
                            clearInterval(pomodoro.intervalId);
                            pomodoro.isRunning = false;
                        }
                        if (manual) {
                            pomodoro.isBreak = false;
                            pomodoro.sessions.current = 0;
                            App.ui.showNotification('Pomodoro reset.', 'warning');
                        }
                        pomodoro.timeLeft = (pomodoro.isBreak ? pomodoro.settings.break : pomodoro.settings.focus) * 60;
                        App.ui.renderPomodoro();
                        App.ui.renderFocusView();
                    }
                },
                ambientSounds: {
                    init() {
                        App.state.ambient.audioElements = {
                            rain: document.getElementById('audio-rain'),
                            cafe: document.getElementById('audio-cafe'),
                            forest: document.getElementById('audio-forest')
                        };
                        document.getElementById('ambient-sounds-modal').addEventListener('click', this.handleInteraction.bind(this));
                    },
                    handleInteraction(e) {
                        const playBtn = e.target.closest('.sound-play-btn');
                        const volumeSlider = e.target.closest('.sound-volume');

                        if (playBtn) {
                            const soundName = playBtn.dataset.sound;
                            this.toggleSound(soundName);
                        }
                        if (volumeSlider) {
                             const soundName = volumeSlider.dataset.sound;
                            this.setVolume(soundName, volumeSlider.value);
                        }
                    },
                    toggleSound(soundName) {
                        const { audioElements, currentSound } = App.state.ambient;
                        const audio = audioElements[soundName];
                        const btn = document.querySelector(`.sound-play-btn[data-sound="${soundName}"]`);

                        if (currentSound && currentSound !== soundName) {
                            audioElements[currentSound].pause();
                            const otherBtn = document.querySelector(`.sound-play-btn[data-sound="${currentSound}"]`);
                            otherBtn.textContent = '‚ñ∂Ô∏è';
                            otherBtn.classList.remove('playing');
                        }
                       
                        if (audio.paused) {
                            audio.play();
                            btn.textContent = '‚è∏Ô∏è';
                            btn.classList.add('playing');
                            App.state.ambient.currentSound = soundName;
                        } else {
                            audio.pause();
                            btn.textContent = '‚ñ∂Ô∏è';
                            btn.classList.remove('playing');
                            App.state.ambient.currentSound = null;
                        }
                    },
                    setVolume(soundName, volume) {
                        App.state.ambient.audioElements[soundName].volume = volume;
                    }
                },
                showHoroscope() { const horoscopes = [ { emoji: "‚ôà", quote: "A burst of energy finds you today. Channel it into a project you're passionate about!" }, { emoji: "‚ôâ", quote: "Patience is your ally. A slow and steady approach will lead to sweet success." }, { emoji: "‚ôä", quote: "Your curiosity is your superpower. Ask questions and explore a new idea." }, { emoji: "‚ôã", quote: "Listen to your heart. Your intuition is guiding you toward a comforting truth." }, { emoji: "‚ôå", quote: "Don't be afraid to shine! Your natural charisma will open doors for you today." }, { emoji: "‚ôç", quote: "A small act of organization will bring you great peace of mind. Tidy your space or your schedule." } ]; const {emoji, quote} = horoscopes[Math.floor(Math.random() * horoscopes.length)]; document.getElementById('horoscope-emoji').textContent = emoji; document.getElementById('horoscope-text').textContent = quote; this.openModal('horoscope-modal'); }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.dataManager.load();
            App.dataManager.updateStreak();
            App.ui.init();
        });
    })();
    </script>
</body>
</html>